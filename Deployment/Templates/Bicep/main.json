{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.39.26.7824",
      "templateHash": "3749134802707814966"
    }
  },
  "parameters": {
    "tenantId": {
      "type": "string",
      "defaultValue": "[subscription().tenantId]",
      "minLength": 36,
      "maxLength": 36,
      "metadata": {
        "description": "Tenant Id"
      }
    },
    "subscriptionId": {
      "type": "string",
      "minLength": 36,
      "maxLength": 36,
      "metadata": {
        "description": "Azure Subscription Id"
      }
    },
    "solutionName": {
      "type": "string",
      "minLength": 3,
      "maxLength": 15,
      "metadata": {
        "description": "Solution Name"
      }
    },
    "solutionLocation": {
      "type": "string",
      "minLength": 3,
      "maxLength": 15,
      "metadata": {
        "description": "Solution Location"
      }
    },
    "dnsZonesName": {
      "type": "string",
      "metadata": {
        "description": "DNS Zone Name."
      }
    },
    "linuxAdminUserName": {
      "type": "string",
      "minLength": 5,
      "maxLength": 30,
      "metadata": {
        "description": "Linux Admin Username"
      }
    },
    "sshRSAPublicKey": {
      "type": "string",
      "metadata": {
        "description": "SSH RSA Publick Key"
      }
    },
    "sqlAdminLogin": {
      "type": "string",
      "metadata": {
        "description": "SQL Administrator Login."
      }
    },
    "sqlAdminPassword": {
      "type": "securestring",
      "metadata": {
        "description": "SQL Administrator Password."
      }
    }
  },
  "variables": {
    "rgNetworkName": "[format('{0}_{1}_network', parameters('solutionName'), parameters('solutionLocation'))]",
    "rgServicesName": "[format('{0}_{1}_services', parameters('solutionName'), parameters('solutionLocation'))]",
    "rgStorageName": "[format('{0}_{1}_storage', parameters('solutionName'), parameters('solutionLocation'))]",
    "rgDataName": "[format('{0}_{1}_data', parameters('solutionName'), parameters('solutionLocation'))]",
    "rgAnalyticsName": "[format('{0}_{1}_analytics', parameters('solutionName'), parameters('solutionLocation'))]",
    "rgAIName": "[format('{0}_{1}_ai', parameters('solutionName'), parameters('solutionLocation'))]",
    "azureDatabricksEnterpriseApplicationObjectId": "4e0ed970-b4e4-4fac-be7b-c73ff733bf7c"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('{0}-resourceGroupsDeployment', parameters('solutionName'))]",
      "subscriptionId": "[parameters('subscriptionId')]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "solutionName": {
            "value": "[parameters('solutionName')]"
          },
          "solutionLocation": {
            "value": "[parameters('solutionLocation')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "9001771368750902366"
            }
          },
          "parameters": {
            "solutionName": {
              "type": "string",
              "minLength": 3,
              "maxLength": 15,
              "metadata": {
                "description": "Project Name:"
              }
            },
            "solutionLocation": {
              "type": "string",
              "metadata": {
                "description": "Project Location:"
              }
            }
          },
          "variables": {
            "rgNames": [
              "[format('{0}_{1}_network', parameters('solutionName'), parameters('solutionLocation'))]",
              "[format('{0}_{1}_services', parameters('solutionName'), parameters('solutionLocation'))]",
              "[format('{0}_{1}_data', parameters('solutionName'), parameters('solutionLocation'))]",
              "[format('{0}_{1}_storage', parameters('solutionName'), parameters('solutionLocation'))]",
              "[format('{0}_{1}_ai', parameters('solutionName'), parameters('solutionLocation'))]",
              "[format('{0}_{1}_analytics', parameters('solutionName'), parameters('solutionLocation'))]"
            ]
          },
          "resources": [
            {
              "type": "Microsoft.Resources/resourceGroups",
              "apiVersion": "2021-04-01",
              "name": "[variables('rgNames')[0]]",
              "location": "[parameters('solutionLocation')]",
              "tags": {
                "app": "[parameters('solutionName')]",
                "location": "[parameters('solutionLocation')]"
              }
            },
            {
              "type": "Microsoft.Resources/resourceGroups",
              "apiVersion": "2021-04-01",
              "name": "[variables('rgNames')[1]]",
              "location": "[parameters('solutionLocation')]",
              "tags": {
                "app": "[parameters('solutionName')]",
                "location": "[parameters('solutionLocation')]"
              }
            },
            {
              "type": "Microsoft.Resources/resourceGroups",
              "apiVersion": "2021-04-01",
              "name": "[variables('rgNames')[2]]",
              "location": "[parameters('solutionLocation')]",
              "tags": {
                "app": "[parameters('solutionName')]",
                "location": "[parameters('solutionLocation')]"
              }
            },
            {
              "type": "Microsoft.Resources/resourceGroups",
              "apiVersion": "2021-04-01",
              "name": "[variables('rgNames')[3]]",
              "location": "[parameters('solutionLocation')]",
              "tags": {
                "app": "[parameters('solutionName')]",
                "location": "[parameters('solutionLocation')]"
              }
            },
            {
              "type": "Microsoft.Resources/resourceGroups",
              "apiVersion": "2021-04-01",
              "name": "[variables('rgNames')[4]]",
              "location": "[parameters('solutionLocation')]",
              "tags": {
                "app": "[parameters('solutionName')]",
                "location": "[parameters('solutionLocation')]"
              }
            },
            {
              "type": "Microsoft.Resources/resourceGroups",
              "apiVersion": "2021-04-01",
              "name": "[variables('rgNames')[5]]",
              "location": "[parameters('solutionLocation')]",
              "tags": {
                "app": "[parameters('solutionName')]",
                "location": "[parameters('solutionLocation')]"
              }
            }
          ],
          "outputs": {
            "resourceGroupsOutput": {
              "type": "object",
              "value": {
                "network": {
                  "id": "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('rgNames')[0])]",
                  "name": "[variables('rgNames')[0]]",
                  "location": "[reference(subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('rgNames')[0]), '2021-04-01', 'full').location]",
                  "properties": "[reference(subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('rgNames')[0]), '2021-04-01')]"
                },
                "services": {
                  "id": "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('rgNames')[1])]",
                  "name": "[variables('rgNames')[1]]",
                  "location": "[reference(subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('rgNames')[1]), '2021-04-01', 'full').location]",
                  "properties": "[reference(subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('rgNames')[1]), '2021-04-01')]"
                },
                "data": {
                  "id": "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('rgNames')[2])]",
                  "name": "[variables('rgNames')[2]]",
                  "location": "[reference(subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('rgNames')[2]), '2021-04-01', 'full').location]",
                  "properties": "[reference(subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('rgNames')[2]), '2021-04-01')]"
                },
                "storage": {
                  "id": "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('rgNames')[3])]",
                  "name": "[variables('rgNames')[3]]",
                  "location": "[reference(subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('rgNames')[3]), '2021-04-01', 'full').location]",
                  "properties": "[reference(subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('rgNames')[3]), '2021-04-01')]"
                },
                "ai": {
                  "id": "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('rgNames')[4])]",
                  "name": "[variables('rgNames')[4]]",
                  "location": "[reference(subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('rgNames')[4]), '2021-04-01', 'full').location]",
                  "properties": "[reference(subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('rgNames')[4]), '2021-04-01')]"
                },
                "analytics": {
                  "id": "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('rgNames')[5])]",
                  "name": "[variables('rgNames')[5]]",
                  "location": "[reference(subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('rgNames')[5]), '2021-04-01', 'full').location]",
                  "properties": "[reference(subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('rgNames')[5]), '2021-04-01')]"
                }
              }
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('{0}-managedIdentityDeployment', parameters('solutionName'))]",
      "resourceGroup": "[variables('rgServicesName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "solutionName": {
            "value": "[parameters('solutionName')]"
          },
          "solutionLocation": {
            "value": "[parameters('solutionLocation')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "6620840401399054840"
            }
          },
          "parameters": {
            "solutionName": {
              "type": "string",
              "minLength": 3,
              "maxLength": 15,
              "metadata": {
                "description": "Solution Name"
              }
            },
            "solutionLocation": {
              "type": "string",
              "metadata": {
                "description": "Solution Location"
              }
            },
            "miName": {
              "type": "string",
              "defaultValue": "[format('{0}-mi', parameters('solutionName'))]",
              "metadata": {
                "description": "Name"
              }
            }
          },
          "variables": {
            "customRoleName": "[guid(resourceGroup().id, resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('miName')), parameters('miName'), parameters('solutionName'))]"
          },
          "resources": [
            {
              "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
              "apiVersion": "2025-01-31-preview",
              "name": "[parameters('miName')]",
              "location": "[parameters('solutionLocation')]",
              "tags": {
                "app": "[parameters('solutionName')]",
                "location": "[parameters('solutionLocation')]"
              }
            },
            {
              "type": "Microsoft.Authorization/roleDefinitions",
              "apiVersion": "2022-05-01-preview",
              "name": "[variables('customRoleName')]",
              "properties": {
                "roleName": "[variables('customRoleName')]",
                "assignableScopes": [
                  "[subscription().id]",
                  "[resourceGroup().id]"
                ],
                "description": "[format('Configure least privilege for the deployment principal - {0}', parameters('solutionName'))]",
                "type": "customRole",
                "permissions": [
                  {
                    "actions": [
                      "Microsoft.ContainerRegistry/registries/pull/read",
                      "Microsoft.ContainerService/managedClusters/listClusterAdminCredential/action",
                      "Microsoft.ContainerService/managedClusters/accessProfiles/listCredential/action",
                      "Microsoft.ContainerService/managedClusters/read",
                      "Microsoft.ContainerService/managedClusters/runcommand/action",
                      "Microsoft.Storage/StorageAccounts/*",
                      "Microsoft.ContainerInstance/containerGroups/*",
                      "Microsoft.Resources/deployments/*",
                      "Microsoft.Resources/deploymentScripts/*",
                      "Microsoft.Storage/register/action",
                      "Microsoft.ContainerInstance/register/action"
                    ]
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('miName'))]"
              ]
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "name": "[guid(resourceGroup().id, resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('miName')), resourceId('Microsoft.Authorization/roleDefinitions', variables('customRoleName')))]",
              "properties": {
                "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('miName')), '2025-01-31-preview').principalId]",
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', variables('customRoleName'))]",
                "principalType": "ServicePrincipal"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Authorization/roleDefinitions', variables('customRoleName'))]",
                "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('miName'))]"
              ]
            }
          ],
          "outputs": {
            "managedIdentityOutput": {
              "type": "object",
              "value": {
                "id": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('miName'))]",
                "clientId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('miName')), '2025-01-31-preview').clientId]",
                "objectId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('miName')), '2025-01-31-preview').principalId]",
                "name": "[parameters('miName')]"
              }
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId(parameters('subscriptionId'), 'Microsoft.Resources/deployments', format('{0}-resourceGroupsDeployment', parameters('solutionName')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('{0}-dnsZonesDeployment', parameters('solutionName'))]",
      "resourceGroup": "[variables('rgNetworkName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "solutionName": {
            "value": "[parameters('solutionName')]"
          },
          "solutionLocation": {
            "value": "[parameters('solutionLocation')]"
          },
          "dnsZonesName": {
            "value": "[parameters('dnsZonesName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "9974042271494537960"
            }
          },
          "parameters": {
            "solutionName": {
              "type": "string",
              "minLength": 3,
              "maxLength": 15,
              "metadata": {
                "description": "Solution Name"
              }
            },
            "solutionLocation": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Solution Location"
              }
            },
            "dnsZonesName": {
              "type": "string",
              "defaultValue": "[format('{0}.com', parameters('solutionName'))]",
              "metadata": {
                "description": "DNS Zone Name."
              }
            },
            "dnsZonesType": {
              "type": "string",
              "defaultValue": "Public",
              "allowedValues": [
                "Public",
                "Private"
              ],
              "metadata": {
                "description": "DNS Zone Type. The type of this DNS zone (Public or Private)."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Network/dnsZones",
              "apiVersion": "2023-07-01-preview",
              "name": "[parameters('dnsZonesName')]",
              "location": "Global",
              "tags": {
                "app": "[parameters('solutionName')]",
                "location": "Global"
              },
              "properties": {
                "zoneType": "[parameters('dnsZonesType')]"
              }
            }
          ],
          "outputs": {
            "dnsZonesOutput": {
              "type": "object",
              "value": {
                "id": "[resourceId('Microsoft.Network/dnsZones', parameters('dnsZonesName'))]",
                "name": "[parameters('dnsZonesName')]"
              }
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId(parameters('subscriptionId'), 'Microsoft.Resources/deployments', format('{0}-resourceGroupsDeployment', parameters('solutionName')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('{0}-publicIpAddressAppGatewayDeployment', parameters('solutionName'))]",
      "resourceGroup": "[variables('rgNetworkName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "solutionName": {
            "value": "[parameters('solutionName')]"
          },
          "solutionLocation": {
            "value": "[parameters('solutionLocation')]"
          },
          "domainNameLabel": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNetworkName')), 'Microsoft.Resources/deployments', format('{0}-dnsZonesDeployment', parameters('solutionName'))), '2025-04-01').outputs.dnsZonesOutput.value.name]"
          },
          "pipName": {
            "value": "[format('{0}-pip-ag', parameters('solutionName'))]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "12379273977177398079"
            }
          },
          "parameters": {
            "solutionName": {
              "type": "string",
              "minLength": 3,
              "maxLength": 15,
              "metadata": {
                "description": "Solution Name"
              }
            },
            "solutionLocation": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Solution Location"
              }
            },
            "pipName": {
              "type": "string",
              "defaultValue": "[format('{0}-pip', parameters('solutionName'))]",
              "metadata": {
                "description": "Name"
              }
            },
            "skuName": {
              "type": "string",
              "defaultValue": "Standard",
              "allowedValues": [
                "Basic",
                "Standard"
              ],
              "metadata": {
                "description": "SKU Name. Name of a public IP address SKU."
              }
            },
            "skuTier": {
              "type": "string",
              "defaultValue": "Regional",
              "allowedValues": [
                "Global",
                "Regional"
              ],
              "metadata": {
                "description": "SKU Tier. Tier of a public IP address SKU."
              }
            },
            "deleteOption": {
              "type": "string",
              "defaultValue": "Detach",
              "allowedValues": [
                "Delete",
                "Detach"
              ],
              "metadata": {
                "description": "Delete Option. Specify what happens to the public IP address when the VM using it is deleted"
              }
            },
            "domainNameLabel": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Domain Name Label. The concatenation of the domain name label and the regionalized DNS zone make up the fully qualified domain name associated with the public IP address. If a domain name label is specified, an A DNS record is created for the public IP in the Microsoft Azure DNS system."
              }
            },
            "ipTagType": {
              "type": "string",
              "defaultValue": "NetworkDomain",
              "allowedValues": [
                "FirstPartyUsage",
                "NetworkDomain",
                "RoutingPreference"
              ],
              "metadata": {
                "description": "IP Tag Type."
              }
            },
            "domainNameLabelScope": {
              "type": "string",
              "defaultValue": "NoReuse",
              "allowedValues": [
                "NoReuse",
                "ResourceGroupReuse",
                "SubscriptionReuse",
                "TenantReuse"
              ],
              "metadata": {
                "description": "Domain Name Label Scope. If a domain name label and a domain name label scope are specified, an A DNS record is created for the public IP in the Microsoft Azure DNS system with a hashed value includes in FQDN."
              }
            },
            "idleTimeoutInMinutes": {
              "type": "int",
              "defaultValue": 5,
              "metadata": {
                "description": "Idle Timeout In Minutes. The idle timeout of the public IP address."
              }
            },
            "publicIPAddressVersion": {
              "type": "string",
              "defaultValue": "IPv4",
              "allowedValues": [
                "IPv4",
                "IPv6"
              ],
              "metadata": {
                "description": "Public IP Address Version. The public IP address version."
              }
            },
            "publicIPAllocationMethod": {
              "type": "string",
              "defaultValue": "Static",
              "allowedValues": [
                "Dynamic",
                "Static"
              ],
              "metadata": {
                "description": "Public IP Allocation Method. The public IP address allocation method."
              }
            }
          },
          "variables": {
            "pointIndex": "[indexOf(parameters('domainNameLabel'), '.')]",
            "domainName": "[substring(parameters('domainNameLabel'), 0, variables('pointIndex'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Network/publicIPAddresses",
              "apiVersion": "2024-05-01",
              "name": "[parameters('pipName')]",
              "location": "[parameters('solutionLocation')]",
              "sku": {
                "name": "[parameters('skuName')]",
                "tier": "[parameters('skuTier')]"
              },
              "tags": {
                "app": "[parameters('solutionName')]",
                "location": "[parameters('solutionLocation')]"
              },
              "zones": [
                "1",
                "2"
              ],
              "properties": {
                "publicIPAddressVersion": "[parameters('publicIPAddressVersion')]",
                "publicIPAllocationMethod": "[parameters('publicIPAllocationMethod')]",
                "deleteOption": "[parameters('deleteOption')]",
                "idleTimeoutInMinutes": "[parameters('idleTimeoutInMinutes')]",
                "dnsSettings": {
                  "domainNameLabel": "[variables('domainName')]",
                  "domainNameLabelScope": "[parameters('domainNameLabelScope')]"
                },
                "ipTags": [
                  {
                    "ipTagType": "[parameters('ipTagType')]",
                    "tag": "[parameters('solutionName')]"
                  }
                ]
              }
            }
          ],
          "outputs": {
            "publicIpAddressOutput": {
              "type": "object",
              "value": {
                "id": "[resourceId('Microsoft.Network/publicIPAddresses', parameters('pipName'))]",
                "name": "[parameters('pipName')]"
              }
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNetworkName')), 'Microsoft.Resources/deployments', format('{0}-dnsZonesDeployment', parameters('solutionName')))]",
        "[subscriptionResourceId(parameters('subscriptionId'), 'Microsoft.Resources/deployments', format('{0}-resourceGroupsDeployment', parameters('solutionName')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('{0}-publicIpAddressNatGatewayDeployment', parameters('solutionName'))]",
      "resourceGroup": "[variables('rgNetworkName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "solutionName": {
            "value": "[parameters('solutionName')]"
          },
          "solutionLocation": {
            "value": "[parameters('solutionLocation')]"
          },
          "domainNameLabel": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNetworkName')), 'Microsoft.Resources/deployments', format('{0}-dnsZonesDeployment', parameters('solutionName'))), '2025-04-01').outputs.dnsZonesOutput.value.name]"
          },
          "pipName": {
            "value": "[format('{0}-pip-ng', parameters('solutionName'))]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "12379273977177398079"
            }
          },
          "parameters": {
            "solutionName": {
              "type": "string",
              "minLength": 3,
              "maxLength": 15,
              "metadata": {
                "description": "Solution Name"
              }
            },
            "solutionLocation": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Solution Location"
              }
            },
            "pipName": {
              "type": "string",
              "defaultValue": "[format('{0}-pip', parameters('solutionName'))]",
              "metadata": {
                "description": "Name"
              }
            },
            "skuName": {
              "type": "string",
              "defaultValue": "Standard",
              "allowedValues": [
                "Basic",
                "Standard"
              ],
              "metadata": {
                "description": "SKU Name. Name of a public IP address SKU."
              }
            },
            "skuTier": {
              "type": "string",
              "defaultValue": "Regional",
              "allowedValues": [
                "Global",
                "Regional"
              ],
              "metadata": {
                "description": "SKU Tier. Tier of a public IP address SKU."
              }
            },
            "deleteOption": {
              "type": "string",
              "defaultValue": "Detach",
              "allowedValues": [
                "Delete",
                "Detach"
              ],
              "metadata": {
                "description": "Delete Option. Specify what happens to the public IP address when the VM using it is deleted"
              }
            },
            "domainNameLabel": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Domain Name Label. The concatenation of the domain name label and the regionalized DNS zone make up the fully qualified domain name associated with the public IP address. If a domain name label is specified, an A DNS record is created for the public IP in the Microsoft Azure DNS system."
              }
            },
            "ipTagType": {
              "type": "string",
              "defaultValue": "NetworkDomain",
              "allowedValues": [
                "FirstPartyUsage",
                "NetworkDomain",
                "RoutingPreference"
              ],
              "metadata": {
                "description": "IP Tag Type."
              }
            },
            "domainNameLabelScope": {
              "type": "string",
              "defaultValue": "NoReuse",
              "allowedValues": [
                "NoReuse",
                "ResourceGroupReuse",
                "SubscriptionReuse",
                "TenantReuse"
              ],
              "metadata": {
                "description": "Domain Name Label Scope. If a domain name label and a domain name label scope are specified, an A DNS record is created for the public IP in the Microsoft Azure DNS system with a hashed value includes in FQDN."
              }
            },
            "idleTimeoutInMinutes": {
              "type": "int",
              "defaultValue": 5,
              "metadata": {
                "description": "Idle Timeout In Minutes. The idle timeout of the public IP address."
              }
            },
            "publicIPAddressVersion": {
              "type": "string",
              "defaultValue": "IPv4",
              "allowedValues": [
                "IPv4",
                "IPv6"
              ],
              "metadata": {
                "description": "Public IP Address Version. The public IP address version."
              }
            },
            "publicIPAllocationMethod": {
              "type": "string",
              "defaultValue": "Static",
              "allowedValues": [
                "Dynamic",
                "Static"
              ],
              "metadata": {
                "description": "Public IP Allocation Method. The public IP address allocation method."
              }
            }
          },
          "variables": {
            "pointIndex": "[indexOf(parameters('domainNameLabel'), '.')]",
            "domainName": "[substring(parameters('domainNameLabel'), 0, variables('pointIndex'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Network/publicIPAddresses",
              "apiVersion": "2024-05-01",
              "name": "[parameters('pipName')]",
              "location": "[parameters('solutionLocation')]",
              "sku": {
                "name": "[parameters('skuName')]",
                "tier": "[parameters('skuTier')]"
              },
              "tags": {
                "app": "[parameters('solutionName')]",
                "location": "[parameters('solutionLocation')]"
              },
              "zones": [
                "1",
                "2"
              ],
              "properties": {
                "publicIPAddressVersion": "[parameters('publicIPAddressVersion')]",
                "publicIPAllocationMethod": "[parameters('publicIPAllocationMethod')]",
                "deleteOption": "[parameters('deleteOption')]",
                "idleTimeoutInMinutes": "[parameters('idleTimeoutInMinutes')]",
                "dnsSettings": {
                  "domainNameLabel": "[variables('domainName')]",
                  "domainNameLabelScope": "[parameters('domainNameLabelScope')]"
                },
                "ipTags": [
                  {
                    "ipTagType": "[parameters('ipTagType')]",
                    "tag": "[parameters('solutionName')]"
                  }
                ]
              }
            }
          ],
          "outputs": {
            "publicIpAddressOutput": {
              "type": "object",
              "value": {
                "id": "[resourceId('Microsoft.Network/publicIPAddresses', parameters('pipName'))]",
                "name": "[parameters('pipName')]"
              }
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNetworkName')), 'Microsoft.Resources/deployments', format('{0}-dnsZonesDeployment', parameters('solutionName')))]",
        "[subscriptionResourceId(parameters('subscriptionId'), 'Microsoft.Resources/deployments', format('{0}-resourceGroupsDeployment', parameters('solutionName')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('{0}-publicIpAddressVirtualNetworkGatewayDeployment1', parameters('solutionName'))]",
      "resourceGroup": "[variables('rgNetworkName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "solutionName": {
            "value": "[parameters('solutionName')]"
          },
          "solutionLocation": {
            "value": "[parameters('solutionLocation')]"
          },
          "domainNameLabel": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNetworkName')), 'Microsoft.Resources/deployments', format('{0}-dnsZonesDeployment', parameters('solutionName'))), '2025-04-01').outputs.dnsZonesOutput.value.name]"
          },
          "pipName": {
            "value": "[format('{0}-pip-vng-default', parameters('solutionName'))]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "12379273977177398079"
            }
          },
          "parameters": {
            "solutionName": {
              "type": "string",
              "minLength": 3,
              "maxLength": 15,
              "metadata": {
                "description": "Solution Name"
              }
            },
            "solutionLocation": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Solution Location"
              }
            },
            "pipName": {
              "type": "string",
              "defaultValue": "[format('{0}-pip', parameters('solutionName'))]",
              "metadata": {
                "description": "Name"
              }
            },
            "skuName": {
              "type": "string",
              "defaultValue": "Standard",
              "allowedValues": [
                "Basic",
                "Standard"
              ],
              "metadata": {
                "description": "SKU Name. Name of a public IP address SKU."
              }
            },
            "skuTier": {
              "type": "string",
              "defaultValue": "Regional",
              "allowedValues": [
                "Global",
                "Regional"
              ],
              "metadata": {
                "description": "SKU Tier. Tier of a public IP address SKU."
              }
            },
            "deleteOption": {
              "type": "string",
              "defaultValue": "Detach",
              "allowedValues": [
                "Delete",
                "Detach"
              ],
              "metadata": {
                "description": "Delete Option. Specify what happens to the public IP address when the VM using it is deleted"
              }
            },
            "domainNameLabel": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Domain Name Label. The concatenation of the domain name label and the regionalized DNS zone make up the fully qualified domain name associated with the public IP address. If a domain name label is specified, an A DNS record is created for the public IP in the Microsoft Azure DNS system."
              }
            },
            "ipTagType": {
              "type": "string",
              "defaultValue": "NetworkDomain",
              "allowedValues": [
                "FirstPartyUsage",
                "NetworkDomain",
                "RoutingPreference"
              ],
              "metadata": {
                "description": "IP Tag Type."
              }
            },
            "domainNameLabelScope": {
              "type": "string",
              "defaultValue": "NoReuse",
              "allowedValues": [
                "NoReuse",
                "ResourceGroupReuse",
                "SubscriptionReuse",
                "TenantReuse"
              ],
              "metadata": {
                "description": "Domain Name Label Scope. If a domain name label and a domain name label scope are specified, an A DNS record is created for the public IP in the Microsoft Azure DNS system with a hashed value includes in FQDN."
              }
            },
            "idleTimeoutInMinutes": {
              "type": "int",
              "defaultValue": 5,
              "metadata": {
                "description": "Idle Timeout In Minutes. The idle timeout of the public IP address."
              }
            },
            "publicIPAddressVersion": {
              "type": "string",
              "defaultValue": "IPv4",
              "allowedValues": [
                "IPv4",
                "IPv6"
              ],
              "metadata": {
                "description": "Public IP Address Version. The public IP address version."
              }
            },
            "publicIPAllocationMethod": {
              "type": "string",
              "defaultValue": "Static",
              "allowedValues": [
                "Dynamic",
                "Static"
              ],
              "metadata": {
                "description": "Public IP Allocation Method. The public IP address allocation method."
              }
            }
          },
          "variables": {
            "pointIndex": "[indexOf(parameters('domainNameLabel'), '.')]",
            "domainName": "[substring(parameters('domainNameLabel'), 0, variables('pointIndex'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Network/publicIPAddresses",
              "apiVersion": "2024-05-01",
              "name": "[parameters('pipName')]",
              "location": "[parameters('solutionLocation')]",
              "sku": {
                "name": "[parameters('skuName')]",
                "tier": "[parameters('skuTier')]"
              },
              "tags": {
                "app": "[parameters('solutionName')]",
                "location": "[parameters('solutionLocation')]"
              },
              "zones": [
                "1",
                "2"
              ],
              "properties": {
                "publicIPAddressVersion": "[parameters('publicIPAddressVersion')]",
                "publicIPAllocationMethod": "[parameters('publicIPAllocationMethod')]",
                "deleteOption": "[parameters('deleteOption')]",
                "idleTimeoutInMinutes": "[parameters('idleTimeoutInMinutes')]",
                "dnsSettings": {
                  "domainNameLabel": "[variables('domainName')]",
                  "domainNameLabelScope": "[parameters('domainNameLabelScope')]"
                },
                "ipTags": [
                  {
                    "ipTagType": "[parameters('ipTagType')]",
                    "tag": "[parameters('solutionName')]"
                  }
                ]
              }
            }
          ],
          "outputs": {
            "publicIpAddressOutput": {
              "type": "object",
              "value": {
                "id": "[resourceId('Microsoft.Network/publicIPAddresses', parameters('pipName'))]",
                "name": "[parameters('pipName')]"
              }
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNetworkName')), 'Microsoft.Resources/deployments', format('{0}-dnsZonesDeployment', parameters('solutionName')))]",
        "[subscriptionResourceId(parameters('subscriptionId'), 'Microsoft.Resources/deployments', format('{0}-resourceGroupsDeployment', parameters('solutionName')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('{0}-publicIpAddressVirtualNetworkGatewayDeployment2', parameters('solutionName'))]",
      "resourceGroup": "[variables('rgNetworkName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "solutionName": {
            "value": "[parameters('solutionName')]"
          },
          "solutionLocation": {
            "value": "[parameters('solutionLocation')]"
          },
          "domainNameLabel": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNetworkName')), 'Microsoft.Resources/deployments', format('{0}-dnsZonesDeployment', parameters('solutionName'))), '2025-04-01').outputs.dnsZonesOutput.value.name]"
          },
          "pipName": {
            "value": "[format('{0}-pip-vng-activeactive', parameters('solutionName'))]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "12379273977177398079"
            }
          },
          "parameters": {
            "solutionName": {
              "type": "string",
              "minLength": 3,
              "maxLength": 15,
              "metadata": {
                "description": "Solution Name"
              }
            },
            "solutionLocation": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Solution Location"
              }
            },
            "pipName": {
              "type": "string",
              "defaultValue": "[format('{0}-pip', parameters('solutionName'))]",
              "metadata": {
                "description": "Name"
              }
            },
            "skuName": {
              "type": "string",
              "defaultValue": "Standard",
              "allowedValues": [
                "Basic",
                "Standard"
              ],
              "metadata": {
                "description": "SKU Name. Name of a public IP address SKU."
              }
            },
            "skuTier": {
              "type": "string",
              "defaultValue": "Regional",
              "allowedValues": [
                "Global",
                "Regional"
              ],
              "metadata": {
                "description": "SKU Tier. Tier of a public IP address SKU."
              }
            },
            "deleteOption": {
              "type": "string",
              "defaultValue": "Detach",
              "allowedValues": [
                "Delete",
                "Detach"
              ],
              "metadata": {
                "description": "Delete Option. Specify what happens to the public IP address when the VM using it is deleted"
              }
            },
            "domainNameLabel": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Domain Name Label. The concatenation of the domain name label and the regionalized DNS zone make up the fully qualified domain name associated with the public IP address. If a domain name label is specified, an A DNS record is created for the public IP in the Microsoft Azure DNS system."
              }
            },
            "ipTagType": {
              "type": "string",
              "defaultValue": "NetworkDomain",
              "allowedValues": [
                "FirstPartyUsage",
                "NetworkDomain",
                "RoutingPreference"
              ],
              "metadata": {
                "description": "IP Tag Type."
              }
            },
            "domainNameLabelScope": {
              "type": "string",
              "defaultValue": "NoReuse",
              "allowedValues": [
                "NoReuse",
                "ResourceGroupReuse",
                "SubscriptionReuse",
                "TenantReuse"
              ],
              "metadata": {
                "description": "Domain Name Label Scope. If a domain name label and a domain name label scope are specified, an A DNS record is created for the public IP in the Microsoft Azure DNS system with a hashed value includes in FQDN."
              }
            },
            "idleTimeoutInMinutes": {
              "type": "int",
              "defaultValue": 5,
              "metadata": {
                "description": "Idle Timeout In Minutes. The idle timeout of the public IP address."
              }
            },
            "publicIPAddressVersion": {
              "type": "string",
              "defaultValue": "IPv4",
              "allowedValues": [
                "IPv4",
                "IPv6"
              ],
              "metadata": {
                "description": "Public IP Address Version. The public IP address version."
              }
            },
            "publicIPAllocationMethod": {
              "type": "string",
              "defaultValue": "Static",
              "allowedValues": [
                "Dynamic",
                "Static"
              ],
              "metadata": {
                "description": "Public IP Allocation Method. The public IP address allocation method."
              }
            }
          },
          "variables": {
            "pointIndex": "[indexOf(parameters('domainNameLabel'), '.')]",
            "domainName": "[substring(parameters('domainNameLabel'), 0, variables('pointIndex'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Network/publicIPAddresses",
              "apiVersion": "2024-05-01",
              "name": "[parameters('pipName')]",
              "location": "[parameters('solutionLocation')]",
              "sku": {
                "name": "[parameters('skuName')]",
                "tier": "[parameters('skuTier')]"
              },
              "tags": {
                "app": "[parameters('solutionName')]",
                "location": "[parameters('solutionLocation')]"
              },
              "zones": [
                "1",
                "2"
              ],
              "properties": {
                "publicIPAddressVersion": "[parameters('publicIPAddressVersion')]",
                "publicIPAllocationMethod": "[parameters('publicIPAllocationMethod')]",
                "deleteOption": "[parameters('deleteOption')]",
                "idleTimeoutInMinutes": "[parameters('idleTimeoutInMinutes')]",
                "dnsSettings": {
                  "domainNameLabel": "[variables('domainName')]",
                  "domainNameLabelScope": "[parameters('domainNameLabelScope')]"
                },
                "ipTags": [
                  {
                    "ipTagType": "[parameters('ipTagType')]",
                    "tag": "[parameters('solutionName')]"
                  }
                ]
              }
            }
          ],
          "outputs": {
            "publicIpAddressOutput": {
              "type": "object",
              "value": {
                "id": "[resourceId('Microsoft.Network/publicIPAddresses', parameters('pipName'))]",
                "name": "[parameters('pipName')]"
              }
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNetworkName')), 'Microsoft.Resources/deployments', format('{0}-dnsZonesDeployment', parameters('solutionName')))]",
        "[subscriptionResourceId(parameters('subscriptionId'), 'Microsoft.Resources/deployments', format('{0}-resourceGroupsDeployment', parameters('solutionName')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('{0}-natGatewayDeployment', parameters('solutionName'))]",
      "resourceGroup": "[variables('rgNetworkName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "solutionName": {
            "value": "[parameters('solutionName')]"
          },
          "solutionLocation": {
            "value": "[parameters('solutionLocation')]"
          },
          "publicIpAddressId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNetworkName')), 'Microsoft.Resources/deployments', format('{0}-publicIpAddressNatGatewayDeployment', parameters('solutionName'))), '2025-04-01').outputs.publicIpAddressOutput.value.id]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "12669708216582853484"
            }
          },
          "parameters": {
            "solutionName": {
              "type": "string",
              "minLength": 3,
              "maxLength": 15,
              "metadata": {
                "description": "Solution Name"
              }
            },
            "solutionLocation": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Solution Location"
              }
            },
            "ngName": {
              "type": "string",
              "defaultValue": "[format('{0}-ng', parameters('solutionName'))]",
              "metadata": {
                "description": "Name"
              }
            },
            "skuName": {
              "type": "string",
              "defaultValue": "Standard",
              "metadata": {
                "description": "SKU Name. The nat gateway SKU."
              }
            },
            "idleTimeoutInMinutes": {
              "type": "int",
              "defaultValue": 5,
              "metadata": {
                "description": "Idle Timeout In Minutes. The idle timeout of the public IP address."
              }
            },
            "publicIpAddressId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Public IP Address Id. An array of public ip addresses associated with the nat gateway resource."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Network/natGateways",
              "apiVersion": "2024-05-01",
              "name": "[parameters('ngName')]",
              "location": "[parameters('solutionLocation')]",
              "sku": {
                "name": "[parameters('skuName')]"
              },
              "properties": {
                "idleTimeoutInMinutes": "[parameters('idleTimeoutInMinutes')]",
                "publicIpAddresses": [
                  {
                    "id": "[parameters('publicIpAddressId')]"
                  }
                ]
              }
            }
          ],
          "outputs": {
            "natGatewayOutput": {
              "type": "object",
              "value": {
                "id": "[resourceId('Microsoft.Network/natGateways', parameters('ngName'))]",
                "name": "[parameters('ngName')]"
              }
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNetworkName')), 'Microsoft.Resources/deployments', format('{0}-publicIpAddressNatGatewayDeployment', parameters('solutionName')))]",
        "[subscriptionResourceId(parameters('subscriptionId'), 'Microsoft.Resources/deployments', format('{0}-resourceGroupsDeployment', parameters('solutionName')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('{0}-virtualNetworkDeployment', parameters('solutionName'))]",
      "resourceGroup": "[variables('rgNetworkName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "solutionName": {
            "value": "[parameters('solutionName')]"
          },
          "solutionLocation": {
            "value": "[parameters('solutionLocation')]"
          },
          "natGatewayId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNetworkName')), 'Microsoft.Resources/deployments', format('{0}-natGatewayDeployment', parameters('solutionName'))), '2025-04-01').outputs.natGatewayOutput.value.id]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "13310361090216683813"
            }
          },
          "parameters": {
            "solutionName": {
              "type": "string",
              "minLength": 3,
              "maxLength": 15,
              "metadata": {
                "description": "Solution Name"
              }
            },
            "solutionLocation": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Solution Location"
              }
            },
            "vnName": {
              "type": "string",
              "defaultValue": "[format('{0}-vn', parameters('solutionName'))]",
              "metadata": {
                "description": "Name"
              }
            },
            "flowTimeoutInMinutes": {
              "type": "int",
              "defaultValue": 5,
              "metadata": {
                "description": "Flow Timeout in Minutes. The FlowTimeout value (in minutes) for the Virtual Network."
              }
            },
            "nsgFlushConnection": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "NSG Flush Connection. When enabled, flows created from Network Security Group connections will be re-evaluated when rules are updates. Initial enablement will trigger re-evaluation."
              }
            },
            "natGatewayId": {
              "type": "string",
              "metadata": {
                "description": "NAT Gateway ID. "
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Network/networkSecurityGroups",
              "apiVersion": "2024-07-01",
              "name": "appgateway-nsg",
              "location": "[parameters('solutionLocation')]",
              "tags": {
                "app": "[parameters('solutionName')]",
                "location": "[parameters('solutionLocation')]"
              },
              "properties": {
                "securityRules": [],
                "flushConnection": "[parameters('nsgFlushConnection')]"
              }
            },
            {
              "type": "Microsoft.Network/networkSecurityGroups",
              "apiVersion": "2024-07-01",
              "name": "services-nsg",
              "location": "[parameters('solutionLocation')]",
              "tags": {
                "app": "[parameters('solutionName')]",
                "location": "[parameters('solutionLocation')]"
              },
              "properties": {
                "securityRules": [],
                "flushConnection": "[parameters('nsgFlushConnection')]"
              }
            },
            {
              "type": "Microsoft.Network/networkSecurityGroups",
              "apiVersion": "2024-07-01",
              "name": "databricks-private-nsg",
              "location": "[parameters('solutionLocation')]",
              "tags": {
                "app": "[parameters('solutionName')]",
                "location": "[parameters('solutionLocation')]"
              },
              "properties": {
                "securityRules": [],
                "flushConnection": "[parameters('nsgFlushConnection')]"
              }
            },
            {
              "type": "Microsoft.Network/networkSecurityGroups",
              "apiVersion": "2024-07-01",
              "name": "databricks-public-nsg",
              "location": "[parameters('solutionLocation')]",
              "tags": {
                "app": "[parameters('solutionName')]",
                "location": "[parameters('solutionLocation')]"
              },
              "properties": {
                "securityRules": [],
                "flushConnection": "[parameters('nsgFlushConnection')]"
              }
            },
            {
              "type": "Microsoft.Network/networkSecurityGroups",
              "apiVersion": "2024-07-01",
              "name": "virtual-network-gateway-nsg",
              "location": "[parameters('solutionLocation')]",
              "tags": {
                "app": "[parameters('solutionName')]",
                "location": "[parameters('solutionLocation')]"
              },
              "properties": {
                "securityRules": [],
                "flushConnection": "[parameters('nsgFlushConnection')]"
              }
            },
            {
              "type": "Microsoft.Network/networkSecurityGroups",
              "apiVersion": "2024-07-01",
              "name": "local-network-gateway-nsg",
              "location": "[parameters('solutionLocation')]",
              "tags": {
                "app": "[parameters('solutionName')]",
                "location": "[parameters('solutionLocation')]"
              },
              "properties": {
                "securityRules": [],
                "flushConnection": "[parameters('nsgFlushConnection')]"
              }
            },
            {
              "type": "Microsoft.Network/networkSecurityGroups",
              "apiVersion": "2024-07-01",
              "name": "natgateway-nsg",
              "location": "[parameters('solutionLocation')]",
              "tags": {
                "app": "[parameters('solutionName')]",
                "location": "[parameters('solutionLocation')]"
              },
              "properties": {
                "securityRules": [],
                "flushConnection": "[parameters('nsgFlushConnection')]"
              }
            },
            {
              "type": "Microsoft.Network/virtualNetworks",
              "apiVersion": "2024-10-01",
              "name": "[parameters('vnName')]",
              "location": "[parameters('solutionLocation')]",
              "properties": {
                "addressSpace": {
                  "addressPrefixes": [
                    "10.224.0.0/12"
                  ]
                },
                "subnets": [
                  {
                    "name": "subnet-appgateway",
                    "properties": {
                      "addressPrefix": "10.224.0.0/24"
                    }
                  },
                  {
                    "name": "subnet-services",
                    "properties": {
                      "addressPrefix": "10.225.0.0/24",
                      "natGateway": {
                        "id": "[parameters('natGatewayId')]"
                      },
                      "networkSecurityGroup": {
                        "id": "[resourceId('Microsoft.Network/networkSecurityGroups', 'services-nsg')]"
                      }
                    }
                  },
                  {
                    "name": "subnet-databricks-private",
                    "properties": {
                      "addressPrefix": "10.226.0.0/16",
                      "delegations": [
                        {
                          "name": "subnetDatabricksPublicDelegation",
                          "properties": {
                            "serviceName": "Microsoft.Databricks/workspaces"
                          }
                        }
                      ],
                      "networkSecurityGroup": {
                        "id": "[resourceId('Microsoft.Network/networkSecurityGroups', 'databricks-private-nsg')]"
                      }
                    }
                  },
                  {
                    "name": "subnet-databricks-public",
                    "properties": {
                      "addressPrefix": "10.227.0.0/16",
                      "delegations": [
                        {
                          "name": "subnetDatabricksPublicDelegation",
                          "properties": {
                            "serviceName": "Microsoft.Databricks/workspaces"
                          }
                        }
                      ],
                      "networkSecurityGroup": {
                        "id": "[resourceId('Microsoft.Network/networkSecurityGroups', 'databricks-public-nsg')]"
                      }
                    }
                  },
                  {
                    "name": "GatewaySubnet",
                    "properties": {
                      "addressPrefix": "10.230.0.0/16"
                    }
                  },
                  {
                    "name": "subnet-localnetworkgateway",
                    "properties": {
                      "addressPrefix": "10.231.0.0/16",
                      "networkSecurityGroup": {
                        "id": "[resourceId('Microsoft.Network/networkSecurityGroups', 'local-network-gateway-nsg')]"
                      }
                    }
                  },
                  {
                    "name": "subnet-natgateway",
                    "properties": {
                      "addressPrefix": "10.239.0.0/16",
                      "networkSecurityGroup": {
                        "id": "[resourceId('Microsoft.Network/networkSecurityGroups', 'natgateway-nsg')]"
                      }
                    }
                  }
                ],
                "flowTimeoutInMinutes": "[parameters('flowTimeoutInMinutes')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', 'databricks-private-nsg')]",
                "[resourceId('Microsoft.Network/networkSecurityGroups', 'databricks-public-nsg')]",
                "[resourceId('Microsoft.Network/networkSecurityGroups', 'local-network-gateway-nsg')]",
                "[resourceId('Microsoft.Network/networkSecurityGroups', 'natgateway-nsg')]",
                "[resourceId('Microsoft.Network/networkSecurityGroups', 'services-nsg')]"
              ]
            }
          ],
          "outputs": {
            "virtualNetworkOutput": {
              "type": "object",
              "value": {
                "id": "[resourceId('Microsoft.Network/virtualNetworks', parameters('vnName'))]",
                "name": "[parameters('vnName')]",
                "appGatewaySubnet": {
                  "id": "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('vnName')), '2024-10-01').subnets[0].id]",
                  "name": "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('vnName')), '2024-10-01').subnets[0].name]",
                  "addressPrefix": "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('vnName')), '2024-10-01').subnets[0].properties.addressPrefix]"
                },
                "servicesSubnet": {
                  "id": "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('vnName')), '2024-10-01').subnets[1].id]",
                  "name": "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('vnName')), '2024-10-01').subnets[1].name]",
                  "addressPrefix": "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('vnName')), '2024-10-01').subnets[1].properties.addressPrefix]"
                },
                "databricksSubnetPrivate": {
                  "id": "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('vnName')), '2024-10-01').subnets[2].id]",
                  "name": "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('vnName')), '2024-10-01').subnets[2].name]",
                  "addressPrefix": "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('vnName')), '2024-10-01').subnets[2].properties.addressPrefix]"
                },
                "databricksSubnetPublic": {
                  "id": "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('vnName')), '2024-10-01').subnets[3].id]",
                  "name": "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('vnName')), '2024-10-01').subnets[3].name]",
                  "addressPrefix": "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('vnName')), '2024-10-01').subnets[3].properties.addressPrefix]"
                },
                "virtualNetworkGatewaySubnet": {
                  "id": "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('vnName')), '2024-10-01').subnets[4].id]",
                  "name": "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('vnName')), '2024-10-01').subnets[4].name]",
                  "addressPrefix": "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('vnName')), '2024-10-01').subnets[4].properties.addressPrefix]"
                },
                "localNetworkGatewaySubnet": {
                  "id": "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('vnName')), '2024-10-01').subnets[5].id]",
                  "name": "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('vnName')), '2024-10-01').subnets[5].name]",
                  "addressPrefix": "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('vnName')), '2024-10-01').subnets[5].properties.addressPrefix]"
                },
                "natGatewaySubnet": {
                  "id": "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('vnName')), '2024-10-01').subnets[6].id]",
                  "name": "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('vnName')), '2024-10-01').subnets[6].name]",
                  "addressPrefix": "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('vnName')), '2024-10-01').subnets[6].properties.addressPrefix]"
                }
              }
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNetworkName')), 'Microsoft.Resources/deployments', format('{0}-natGatewayDeployment', parameters('solutionName')))]",
        "[subscriptionResourceId(parameters('subscriptionId'), 'Microsoft.Resources/deployments', format('{0}-resourceGroupsDeployment', parameters('solutionName')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('{0}-appGatewayDeployment', parameters('solutionName'))]",
      "resourceGroup": "[variables('rgNetworkName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "solutionName": {
            "value": "[parameters('solutionName')]"
          },
          "solutionLocation": {
            "value": "[parameters('solutionLocation')]"
          },
          "managedIdentityId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgServicesName')), 'Microsoft.Resources/deployments', format('{0}-managedIdentityDeployment', parameters('solutionName'))), '2025-04-01').outputs.managedIdentityOutput.value.id]"
          },
          "managedIdentityPrincipalId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgServicesName')), 'Microsoft.Resources/deployments', format('{0}-managedIdentityDeployment', parameters('solutionName'))), '2025-04-01').outputs.managedIdentityOutput.value.objectId]"
          },
          "publicIpAddress": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNetworkName')), 'Microsoft.Resources/deployments', format('{0}-publicIpAddressAppGatewayDeployment', parameters('solutionName'))), '2025-04-01').outputs.publicIpAddressOutput.value.id]"
          },
          "appGatewaySubnetId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNetworkName')), 'Microsoft.Resources/deployments', format('{0}-virtualNetworkDeployment', parameters('solutionName'))), '2025-04-01').outputs.virtualNetworkOutput.value.appGatewaySubnet.id]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "6332857153165959443"
            }
          },
          "parameters": {
            "solutionName": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "The name of the Managed Cluster resource."
              }
            },
            "solutionLocation": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "The location of the Managed Cluster resource."
              }
            },
            "agName": {
              "type": "string",
              "defaultValue": "[format('{0}-ag', parameters('solutionName'))]",
              "metadata": {
                "description": "App Gateway Name. The name of the Application Gateway resource."
              }
            },
            "managedIdentityId": {
              "type": "string",
              "metadata": {
                "description": "Managed Identity ID. The resource ID of the user assigned identity to be used for the application gateway deployment."
              }
            },
            "managedIdentityPrincipalId": {
              "type": "string",
              "metadata": {
                "description": "Managed Identity Principal Id. The principal ID of the user assigned identity to be used for the application gateway deployment."
              }
            },
            "skuFamily": {
              "type": "string",
              "defaultValue": "Generation_2",
              "allowedValues": [
                "Generation_1",
                "Generation_2"
              ],
              "metadata": {
                "description": "SKU Family. Family of an application gateway SKU."
              }
            },
            "skuName": {
              "type": "string",
              "defaultValue": "WAF_v2",
              "allowedValues": [
                "Basic",
                "Standard_Large",
                "Standard_Medium",
                "Standard_Small",
                "Standard_v2",
                "WAF_Large",
                "WAF_Medium",
                "WAF_v2"
              ],
              "metadata": {
                "description": "SKU Name. Name of an application gateway SKU."
              }
            },
            "skuTier": {
              "type": "string",
              "defaultValue": "WAF_v2",
              "allowedValues": [
                "Basic",
                "Standard",
                "Standard_v2",
                "WAF",
                "WAF_v2"
              ],
              "metadata": {
                "description": "SKU Tier. Tier of an application gateway."
              }
            },
            "maxCapacity": {
              "type": "int",
              "defaultValue": 3,
              "metadata": {
                "description": "Max Capacity. Upper bound on number of Application Gateway capacity."
              }
            },
            "minCapacity": {
              "type": "int",
              "defaultValue": 1,
              "metadata": {
                "description": "Min Capacity. Lower bound on number of Application Gateway capacity."
              }
            },
            "publicIpAddress": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "public IP Address. The resource ID of the public IP address to be associated with the application gateway."
              }
            },
            "appGatewaySubnetId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "App Gateway Subnet Id. The resource ID of the subnet to deploy the application gateway into."
              }
            },
            "drainTimeoutInSec": {
              "type": "int",
              "defaultValue": 60,
              "metadata": {
                "description": "Drain Timeout In Sec. The number of seconds connection draining is active. Acceptable values are from 1 second to 3600 seconds."
              }
            },
            "connectionDraining": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Connection Draining. Whether connection draining is enabled."
              }
            },
            "requestTimeout": {
              "type": "int",
              "defaultValue": 300,
              "metadata": {
                "description": "Request Timeout. Request timeout in seconds. Application Gateway will fail the request if response is not received within RequestTimeout. Acceptable values are from 1 second to 86400 seconds."
              }
            },
            "enableFips": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Enable FIPS. Whether FIPS is enabled on the application gateway resource."
              }
            },
            "enableHttp2": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable HTTP2. Whether HTTP2 is enabled on the application gateway resource."
              }
            },
            "enableRequestBuffering": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable Request Buffering. Enable or disable request buffering."
              }
            },
            "enableResponseBuffering": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable Response Buffering. Enable or disable response buffering."
              }
            },
            "probeEnabled": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Probe Enabled. Wheter the probe is enabled, default value is false."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Network/ApplicationGatewayWebApplicationFirewallPolicies",
              "apiVersion": "2024-05-01",
              "name": "appGatewayWafPolicy",
              "location": "[parameters('solutionLocation')]",
              "properties": {
                "customRules": [
                  {
                    "name": "BlockIPRule",
                    "priority": 1,
                    "ruleType": "MatchRule",
                    "matchConditions": [
                      {
                        "matchVariables": [
                          {
                            "variableName": "RemoteAddr"
                          }
                        ],
                        "operator": "IPMatch",
                        "matchValues": [
                          "192.168.1.1"
                        ]
                      }
                    ],
                    "action": "Block",
                    "state": "Enabled"
                  }
                ],
                "managedRules": {
                  "managedRuleSets": [
                    {
                      "ruleSetType": "OWASP",
                      "ruleSetVersion": "3.1"
                    }
                  ]
                },
                "policySettings": {
                  "fileUploadLimitInMb": 32,
                  "fileUploadEnforcement": true,
                  "state": "Enabled",
                  "mode": "Prevention",
                  "requestBodyCheck": true,
                  "requestBodyEnforcement": true,
                  "requestBodyInspectLimitInKB": 16,
                  "maxRequestBodySizeInKb": 32,
                  "jsChallengeCookieExpirationInMins": 5
                }
              }
            },
            {
              "type": "Microsoft.Network/applicationGateways",
              "apiVersion": "2024-07-01",
              "name": "[parameters('agName')]",
              "location": "[parameters('solutionLocation')]",
              "tags": {
                "app": "[parameters('solutionName')]",
                "location": "[parameters('solutionLocation')]"
              },
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', parameters('managedIdentityId'))]": {}
                }
              },
              "properties": {
                "sku": {
                  "name": "[parameters('skuName')]",
                  "tier": "[parameters('skuTier')]",
                  "family": "[parameters('skuFamily')]"
                },
                "autoscaleConfiguration": {
                  "maxCapacity": "[parameters('maxCapacity')]",
                  "minCapacity": "[parameters('minCapacity')]"
                },
                "gatewayIPConfigurations": [
                  {
                    "name": "appGatewayIpAddress",
                    "properties": {
                      "subnet": {
                        "id": "[parameters('appGatewaySubnetId')]"
                      }
                    }
                  }
                ],
                "frontendIPConfigurations": [
                  {
                    "name": "appGatewayFrontEndIp",
                    "properties": {
                      "privateIPAllocationMethod": "Dynamic",
                      "publicIPAddress": {
                        "id": "[parameters('publicIpAddress')]"
                      }
                    }
                  }
                ],
                "frontendPorts": [
                  {
                    "name": "AppGatewayFrontEndHttpPort",
                    "properties": {
                      "port": 80
                    }
                  },
                  {
                    "name": "AppGatewayFrontEndHttpsPort",
                    "properties": {
                      "port": 443
                    }
                  }
                ],
                "backendAddressPools": [
                  {
                    "name": "appGatewayBackendAddressPools",
                    "properties": {
                      "backendAddresses": []
                    }
                  }
                ],
                "backendHttpSettingsCollection": [
                  {
                    "name": "appGatewayBackendHttpSettings",
                    "properties": {
                      "affinityCookieName": "appGatewayAffinityCookie",
                      "connectionDraining": {
                        "drainTimeoutInSec": "[parameters('drainTimeoutInSec')]",
                        "enabled": "[parameters('connectionDraining')]"
                      },
                      "cookieBasedAffinity": "Enabled",
                      "hostName": "[format('{0}.com', parameters('solutionName'))]",
                      "port": 8080,
                      "probeEnabled": "[parameters('probeEnabled')]",
                      "protocol": "Http",
                      "requestTimeout": "[parameters('requestTimeout')]"
                    }
                  },
                  {
                    "name": "appGatewayBackendHttpsSettings",
                    "properties": {
                      "affinityCookieName": "appGatewayAffinityCookie",
                      "connectionDraining": {
                        "drainTimeoutInSec": "[parameters('drainTimeoutInSec')]",
                        "enabled": "[parameters('connectionDraining')]"
                      },
                      "cookieBasedAffinity": "Enabled",
                      "hostName": "[format('{0}.com', parameters('solutionName'))]",
                      "port": 443,
                      "probeEnabled": "[parameters('probeEnabled')]",
                      "protocol": "Https",
                      "requestTimeout": "[parameters('requestTimeout')]"
                    }
                  }
                ],
                "enableFips": "[parameters('enableFips')]",
                "enableHttp2": "[parameters('enableHttp2')]",
                "globalConfiguration": {
                  "enableRequestBuffering": "[parameters('enableRequestBuffering')]",
                  "enableResponseBuffering": "[parameters('enableResponseBuffering')]"
                },
                "httpListeners": [
                  {
                    "name": "appGatewayHttpListener",
                    "properties": {
                      "firewallPolicy": {
                        "id": "[resourceId('Microsoft.Network/ApplicationGatewayWebApplicationFirewallPolicies', 'appGatewayWafPolicy')]"
                      },
                      "frontendIPConfiguration": {
                        "id": "[resourceId('Microsoft.Network/applicationGateways/frontendIPConfigurations', parameters('agName'), 'appGatewayFrontEndIp')]"
                      },
                      "frontendPort": {
                        "id": "[resourceId('Microsoft.Network/applicationGateways/frontendPorts', parameters('agName'), 'appGatewayFrontEndHttpPort')]"
                      },
                      "protocol": "Http",
                      "hostNames": [
                        "[format('{0}.com', parameters('solutionName'))]"
                      ],
                      "requireServerNameIndication": false
                    }
                  }
                ],
                "requestRoutingRules": [
                  {
                    "name": "appGatewayHttpRoutingRules",
                    "properties": {
                      "priority": 19500,
                      "ruleType": "Basic",
                      "httpListener": {
                        "id": "[resourceId('Microsoft.Network/applicationGateways/HttpListeners', parameters('agName'), 'appGatewayHttpListener')]"
                      },
                      "backendAddressPool": {
                        "id": "[resourceId('Microsoft.Network/applicationGateways/backendAddressPools', parameters('agName'), 'appGatewayBackendAddressPools')]"
                      },
                      "backendHttpSettings": {
                        "id": "[resourceId('Microsoft.Network/applicationGateways/backendHttpSettingsCollection', parameters('agName'), 'appGatewayBackendHttpSettings')]"
                      }
                    }
                  }
                ],
                "probes": [
                  {
                    "name": "appGatewayProbes",
                    "properties": {
                      "protocol": "Http",
                      "host": "localhost",
                      "path": "/",
                      "interval": 30,
                      "timeout": 30,
                      "unhealthyThreshold": 3,
                      "pickHostNameFromBackendHttpSettings": false,
                      "minServers": 0,
                      "match": {
                        "body": "OK",
                        "statusCodes": [
                          "200-399"
                        ]
                      }
                    }
                  }
                ],
                "firewallPolicy": {
                  "id": "[resourceId('Microsoft.Network/ApplicationGatewayWebApplicationFirewallPolicies', 'appGatewayWafPolicy')]"
                },
                "rewriteRuleSets": [],
                "redirectConfigurations": [],
                "privateLinkConfigurations": []
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/ApplicationGatewayWebApplicationFirewallPolicies', 'appGatewayWafPolicy')]"
              ]
            }
          ],
          "outputs": {
            "appGatewayOutput": {
              "type": "object",
              "value": {
                "id": "[resourceId('Microsoft.Network/applicationGateways', parameters('agName'))]",
                "name": "[parameters('agName')]"
              }
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgServicesName')), 'Microsoft.Resources/deployments', format('{0}-managedIdentityDeployment', parameters('solutionName')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNetworkName')), 'Microsoft.Resources/deployments', format('{0}-publicIpAddressAppGatewayDeployment', parameters('solutionName')))]",
        "[subscriptionResourceId(parameters('subscriptionId'), 'Microsoft.Resources/deployments', format('{0}-resourceGroupsDeployment', parameters('solutionName')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNetworkName')), 'Microsoft.Resources/deployments', format('{0}-virtualNetworkDeployment', parameters('solutionName')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('{0}-virtualNetworkGatewayDeployment', parameters('solutionName'))]",
      "resourceGroup": "[variables('rgNetworkName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "solutionName": {
            "value": "[parameters('solutionName')]"
          },
          "solutionLocation": {
            "value": "[parameters('solutionLocation')]"
          },
          "managedIdentityId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgServicesName')), 'Microsoft.Resources/deployments', format('{0}-managedIdentityDeployment', parameters('solutionName'))), '2025-04-01').outputs.managedIdentityOutput.value.id]"
          },
          "enableBgp": {
            "value": true
          },
          "enableBgpRouteTranslationForNat": {
            "value": true
          },
          "virtualNetworkGatewayDefaultPublicIpId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNetworkName')), 'Microsoft.Resources/deployments', format('{0}-publicIpAddressVirtualNetworkGatewayDeployment1', parameters('solutionName'))), '2025-04-01').outputs.publicIpAddressOutput.value.id]"
          },
          "virtualNetworkGatewayActiveActivePublicIpId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNetworkName')), 'Microsoft.Resources/deployments', format('{0}-publicIpAddressVirtualNetworkGatewayDeployment2', parameters('solutionName'))), '2025-04-01').outputs.publicIpAddressOutput.value.id]"
          },
          "virtualNetworkGatewaySubnetId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNetworkName')), 'Microsoft.Resources/deployments', format('{0}-virtualNetworkDeployment', parameters('solutionName'))), '2025-04-01').outputs.virtualNetworkOutput.value.virtualNetworkGatewaySubnet.id]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "11442362220285218667"
            }
          },
          "parameters": {
            "solutionName": {
              "type": "string",
              "minLength": 3,
              "maxLength": 15,
              "metadata": {
                "description": "Solution Name"
              }
            },
            "solutionLocation": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Solution Location"
              }
            },
            "vngName": {
              "type": "string",
              "defaultValue": "[format('{0}-vng', parameters('solutionName'))]",
              "metadata": {
                "description": "Name"
              }
            },
            "managedIdentityId": {
              "type": "string",
              "metadata": {
                "description": "Managed Identity ID. The resource ID of the User Assigned Identity to be used for the Virtual Network Gateway deployment."
              }
            },
            "activeActive": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Active Active. Indicates whether the Virtual Network Gateway is active-active."
              }
            },
            "allowremoteVnetTraffic": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "allow remote VNet Traffic. Indicates whether to allow remote VNet traffic."
              }
            },
            "allowvirtualWanTraffic": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "allow virtual WAN Traffic. Indicates whether to allow virtual WAN traffic."
              }
            },
            "enableBgp": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Enable BGP. Indicates whether BGP is enabled for the Virtual Network Gateway."
              }
            },
            "enableBgpRouteTranslationForNat": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Enable BGP Route Translation For NAT. Indicates whether BGP route translation for NAT is enabled."
              }
            },
            "bgpPeeringAddress": {
              "type": "string",
              "defaultValue": "10.230.0.4,10.230.0.5",
              "metadata": {
                "description": "BGP Peering Address. The BGP peering address of the Virtual Network Gateway."
              }
            },
            "disableIPSecReplayProtection": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Disable IPSec Replay Protection. Indicates whether to disable IPSec replay protection."
              }
            },
            "enableDnsForwarding": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Enable DNS Forwarding. Indicates whether to enable DNS forwarding."
              }
            },
            "enableHighBandwidthVpnGateway": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Enable High Bandwidth VPN Gateway. Indicates whether to enable high bandwidth VPN gateway."
              }
            },
            "enablePrivateIpAddress": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable Private IP Address. Indicates whether to enable private IP address."
              }
            },
            "skuName": {
              "type": "string",
              "defaultValue": "VpnGw2AZ",
              "allowedValues": [
                "Basic",
                "ErGw1AZ",
                "ErGw2AZ",
                "ErGw3AZ",
                "ErGwScale",
                "Alto rendimiento",
                "Standard",
                "Ultra Rendimiento",
                "VpnGw1",
                "VpnGw1AZ",
                "VpnGw2",
                "VpnGw2AZ",
                "VpnGw3",
                "VpnGw3AZ",
                "VpnGw4",
                "VpnGw4AZ",
                "VpnGw5",
                "VpnGw5AZ"
              ]
            },
            "skuTier": {
              "type": "string",
              "defaultValue": "VpnGw2AZ",
              "allowedValues": [
                "Basic",
                "ErGw1AZ",
                "ErGw2AZ",
                "ErGw3AZ",
                "ErGwScale",
                "Alto rendimiento",
                "Standard",
                "Ultra Rendimiento",
                "VpnGw1",
                "VpnGw1AZ",
                "VpnGw2",
                "VpnGw2AZ",
                "VpnGw3",
                "VpnGw3AZ",
                "VpnGw4",
                "VpnGw4AZ",
                "VpnGw5",
                "VpnGw5AZ"
              ]
            },
            "gatewayType": {
              "type": "string",
              "defaultValue": "Vpn",
              "allowedValues": [
                "Vpn",
                "LocalGateway",
                "ExpressRoute"
              ],
              "metadata": {
                "description": "Gateway Type. The type of the Virtual Network Gateway."
              }
            },
            "vpnGatewayGeneration": {
              "type": "string",
              "defaultValue": "Generation2",
              "allowedValues": [
                "None",
                "Generation1",
                "Generation2"
              ]
            },
            "vpnType": {
              "type": "string",
              "defaultValue": "RouteBased",
              "allowedValues": [
                "RouteBased",
                "PolicyBased"
              ]
            },
            "virtualNetworkGatewayDefaultPublicIpId": {
              "type": "string",
              "metadata": {
                "description": "Virtual Network Gateway Default Public IP ID. The resource ID of the Public IP Address to be used for the Virtual Network Gateway."
              }
            },
            "virtualNetworkGatewayActiveActivePublicIpId": {
              "type": "string",
              "metadata": {
                "description": "Virtual Network Gateway Active Active Public IP ID. The resource ID of the Public IP Address to be used for the Virtual Network Gateway in active-active mode."
              }
            },
            "virtualNetworkGatewaySubnetId": {
              "type": "string",
              "metadata": {
                "description": "Virtual Network Gateway Subnet ID. The resource ID of the Subnet to be used for the Virtual Network Gateway."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Network/virtualNetworkGateways",
              "apiVersion": "2025-01-01",
              "name": "[parameters('vngName')]",
              "location": "[parameters('solutionLocation')]",
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', parameters('managedIdentityId'))]": {}
                }
              },
              "properties": {
                "sku": {
                  "name": "[parameters('skuName')]",
                  "tier": "[parameters('skuTier')]"
                },
                "gatewayType": "[parameters('gatewayType')]",
                "vpnGatewayGeneration": "[parameters('vpnGatewayGeneration')]",
                "vpnType": "[parameters('vpnType')]",
                "activeActive": "[parameters('activeActive')]",
                "adminState": "string",
                "allowRemoteVnetTraffic": "[parameters('allowremoteVnetTraffic')]",
                "allowVirtualWanTraffic": "[parameters('allowvirtualWanTraffic')]",
                "autoScaleConfiguration": {
                  "bounds": {
                    "max": 5,
                    "min": 1
                  }
                },
                "ipConfigurations": [
                  {
                    "name": "defaultIpConfig",
                    "properties": {
                      "publicIPAddress": {
                        "id": "[parameters('virtualNetworkGatewayDefaultPublicIpId')]"
                      },
                      "privateIPAllocationMethod": "Dynamic",
                      "subnet": {
                        "id": "[parameters('virtualNetworkGatewaySubnetId')]"
                      }
                    }
                  },
                  {
                    "name": "activeActiveIpConfig",
                    "properties": {
                      "publicIPAddress": {
                        "id": "[parameters('virtualNetworkGatewayActiveActivePublicIpId')]"
                      },
                      "privateIPAllocationMethod": "Dynamic",
                      "subnet": {
                        "id": "[parameters('virtualNetworkGatewaySubnetId')]"
                      }
                    }
                  }
                ],
                "enableBgp": "[parameters('enableBgp')]",
                "enableBgpRouteTranslationForNat": "[parameters('enableBgpRouteTranslationForNat')]",
                "bgpSettings": {
                  "asn": 55555,
                  "bgpPeeringAddress": "[parameters('bgpPeeringAddress')]",
                  "bgpPeeringAddresses": [
                    {
                      "customBgpIpAddresses": [
                        "169.254.21.100"
                      ],
                      "ipconfigurationId": "[resourceId('Microsoft.Network/virtualNetworkGateways/ipConfigurations', parameters('vngName'), 'defaultIpConfig')]"
                    },
                    {
                      "customBgpIpAddresses": [
                        "169.254.21.101"
                      ],
                      "ipconfigurationId": "[resourceId('Microsoft.Network/virtualNetworkGateways/ipConfigurations', parameters('vngName'), 'activeActiveIpConfig')]"
                    }
                  ],
                  "peerWeight": 0
                },
                "disableIPSecReplayProtection": "[parameters('disableIPSecReplayProtection')]",
                "enableDnsForwarding": "[parameters('enableDnsForwarding')]",
                "enableHighBandwidthVpnGateway": "[parameters('enableHighBandwidthVpnGateway')]",
                "enablePrivateIpAddress": "[parameters('enablePrivateIpAddress')]"
              }
            }
          ],
          "outputs": {
            "virtualNetworkGatewayOutput": {
              "type": "object",
              "value": {
                "id": "[resourceId('Microsoft.Network/virtualNetworkGateways', parameters('vngName'))]",
                "name": "[parameters('vngName')]"
              }
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgServicesName')), 'Microsoft.Resources/deployments', format('{0}-managedIdentityDeployment', parameters('solutionName')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNetworkName')), 'Microsoft.Resources/deployments', format('{0}-publicIpAddressVirtualNetworkGatewayDeployment2', parameters('solutionName')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNetworkName')), 'Microsoft.Resources/deployments', format('{0}-publicIpAddressVirtualNetworkGatewayDeployment1', parameters('solutionName')))]",
        "[subscriptionResourceId(parameters('subscriptionId'), 'Microsoft.Resources/deployments', format('{0}-resourceGroupsDeployment', parameters('solutionName')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNetworkName')), 'Microsoft.Resources/deployments', format('{0}-virtualNetworkDeployment', parameters('solutionName')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('{0}-keyvaultDeployment', parameters('solutionName'))]",
      "resourceGroup": "[variables('rgStorageName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "solutionName": {
            "value": "[parameters('solutionName')]"
          },
          "solutionLocation": {
            "value": "[parameters('solutionLocation')]"
          },
          "tenantId": {
            "value": "[subscription().tenantId]"
          },
          "managedIdentityPrincipalId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgServicesName')), 'Microsoft.Resources/deployments', format('{0}-managedIdentityDeployment', parameters('solutionName'))), '2025-04-01').outputs.managedIdentityOutput.value.objectId]"
          },
          "enablePurgeProtection": {
            "value": true
          },
          "enableSoftDelete": {
            "value": true
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "16333796662115732109"
            }
          },
          "parameters": {
            "solutionName": {
              "type": "string",
              "minLength": 3,
              "maxLength": 15,
              "metadata": {
                "description": "Solution Name"
              }
            },
            "solutionLocation": {
              "type": "string",
              "metadata": {
                "description": "Solution Location"
              }
            },
            "kvName": {
              "type": "string",
              "defaultValue": "[format('{0}-kv', parameters('solutionName'))]",
              "metadata": {
                "description": "Name"
              }
            },
            "createMode": {
              "type": "string",
              "defaultValue": "default",
              "metadata": {
                "description": "Create Mode"
              }
            },
            "enableForDeployment": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enabled For Deployment. Property to specify whether Azure Virtual Machines are permitted to retrieve certificates stored as secrets from the key vault."
              }
            },
            "enableForDiskEncryption": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enabled For Disk Encryption. Property to specify whether Azure Disk Encryption is permitted to retrieve secrets from the vault and unwrap keys."
              }
            },
            "enableForTemplateDeployment": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enabled For Template Deployment. Property to specify whether Azure Resource Manager is permitted to retrieve secrets from the key vault."
              }
            },
            "enablePurgeProtection": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Enable Purge Protection. Property specifying whether protection against purge is enabled for this vault."
              }
            },
            "enableRBACAuthorization": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable RBAC Authorization. Property that controls how data actions are authorized."
              }
            },
            "enableSoftDelete": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Enable Soft Delete. Property to specify whether the \"soft delete\" functionality is enabled for this key vault."
              }
            },
            "softDeleteRetentionInDays": {
              "type": "int",
              "defaultValue": 30,
              "metadata": {
                "description": "Soft Delete Retention in Days. softDelete data retention days. It accepts >=7 and <=90."
              }
            },
            "publicNetworkAccess": {
              "type": "string",
              "defaultValue": "enabled",
              "allowedValues": [
                "enabled",
                "disabled"
              ],
              "metadata": {
                "description": "Public Network Access, Property to specify whether the vault will accept traffic from public internet."
              }
            },
            "sku": {
              "type": "string",
              "defaultValue": "standard",
              "allowedValues": [
                "standard",
                "premium"
              ],
              "metadata": {
                "description": "SKU"
              }
            },
            "tenantId": {
              "type": "string",
              "metadata": {
                "description": "Tenant Id"
              }
            },
            "managedIdentityPrincipalId": {
              "type": "string",
              "metadata": {
                "description": "Managed Identity Object Id. The object id of the managed identity that will access the Key Vault."
              }
            },
            "encryptionKeyName": {
              "type": "string",
              "defaultValue": "encryptionKey",
              "metadata": {
                "description": "Encryption Key Name."
              }
            },
            "expDate": {
              "type": "int",
              "defaultValue": "[dateTimeToEpoch(dateTimeAdd(utcNow(), 'P6M'))]"
            }
          },
          "variables": {
            "vaultUri": "[format('https://{0}.vault.azure.net/', parameters('kvName'))]"
          },
          "resources": [
            {
              "type": "Microsoft.KeyVault/vaults",
              "apiVersion": "2025-05-01",
              "name": "[parameters('kvName')]",
              "location": "[parameters('solutionLocation')]",
              "tags": {
                "app": "[parameters('solutionName')]",
                "location": "[parameters('solutionLocation')]"
              },
              "properties": {
                "accessPolicies": [
                  {
                    "objectId": "[parameters('managedIdentityPrincipalId')]",
                    "permissions": {
                      "certificates": [
                        "all"
                      ],
                      "keys": [
                        "all"
                      ],
                      "secrets": [
                        "all"
                      ],
                      "storage": [
                        "all"
                      ]
                    },
                    "tenantId": "[parameters('tenantId')]"
                  }
                ],
                "createMode": "[parameters('createMode')]",
                "enabledForDeployment": "[parameters('enableForDeployment')]",
                "enabledForDiskEncryption": "[parameters('enableForDiskEncryption')]",
                "enabledForTemplateDeployment": "[parameters('enableForTemplateDeployment')]",
                "enablePurgeProtection": "[parameters('enablePurgeProtection')]",
                "enableRbacAuthorization": "[parameters('enableRBACAuthorization')]",
                "enableSoftDelete": "[parameters('enableSoftDelete')]",
                "softDeleteRetentionInDays": "[parameters('softDeleteRetentionInDays')]",
                "provisioningState": "RegisteringDns",
                "publicNetworkAccess": "[parameters('publicNetworkAccess')]",
                "sku": {
                  "family": "A",
                  "name": "[parameters('sku')]"
                },
                "tenantId": "[parameters('tenantId')]",
                "vaultUri": "[variables('vaultUri')]"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "name": "[guid(resourceGroup().id, parameters('managedIdentityPrincipalId'), resourceId('Microsoft.Authorization/roleDefinitions', '00482a5a-887f-4fb3-b363-3b7fe8e74483'))]",
              "properties": {
                "principalId": "[parameters('managedIdentityPrincipalId')]",
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', '00482a5a-887f-4fb3-b363-3b7fe8e74483')]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "type": "Microsoft.KeyVault/vaults/keys",
              "apiVersion": "2022-07-01",
              "name": "[format('{0}/{1}', parameters('kvName'), parameters('encryptionKeyName'))]",
              "tags": {
                "app": "[parameters('solutionName')]",
                "location": "[parameters('solutionLocation')]"
              },
              "properties": {
                "attributes": {
                  "enabled": true,
                  "exp": "[parameters('expDate')]"
                },
                "curveName": "P256-K",
                "keyOps": [
                  "encrypt",
                  "decrypt",
                  "sign",
                  "unwrapKey",
                  "verify",
                  "wrapKey"
                ],
                "keySize": 2048,
                "kty": "RSA",
                "rotationPolicy": {
                  "attributes": {
                    "expiryTime": "P6M"
                  },
                  "lifetimeActions": [
                    {
                      "action": {
                        "type": "rotate"
                      },
                      "trigger": {
                        "timeAfterCreate": "P5M"
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', parameters('kvName'))]"
              ]
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.KeyVault/vaults/{0}', parameters('kvName'))]",
              "name": "[guid(parameters('managedIdentityPrincipalId'), resourceId('Microsoft.KeyVault/vaults', parameters('kvName')), 'Key Vault Crypto Service Encryption User')]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'e147488a-f6f5-4113-8e2d-b22465e65bf6')]",
                "principalId": "[parameters('managedIdentityPrincipalId')]",
                "principalType": "ServicePrincipal"
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', parameters('kvName'))]"
              ]
            }
          ],
          "outputs": {
            "keyvaultOutput": {
              "type": "object",
              "value": {
                "id": "[resourceId('Microsoft.KeyVault/vaults', parameters('kvName'))]",
                "name": "[parameters('kvName')]",
                "uri": "[variables('vaultUri')]",
                "keys": [
                  {
                    "name": "[parameters('encryptionKeyName')]",
                    "uri": "[string(reference(resourceId('Microsoft.KeyVault/vaults/keys', parameters('kvName'), parameters('encryptionKeyName')), '2022-07-01').keyUriWithVersion)]",
                    "version": "[substring(string(reference(resourceId('Microsoft.KeyVault/vaults/keys', parameters('kvName'), parameters('encryptionKeyName')), '2022-07-01').keyUriWithVersion), add(lastIndexOf(string(reference(resourceId('Microsoft.KeyVault/vaults/keys', parameters('kvName'), parameters('encryptionKeyName')), '2022-07-01').keyUriWithVersion), '/'), 1), sub(sub(length(string(reference(resourceId('Microsoft.KeyVault/vaults/keys', parameters('kvName'), parameters('encryptionKeyName')), '2022-07-01').keyUriWithVersion)), 1), lastIndexOf(string(reference(resourceId('Microsoft.KeyVault/vaults/keys', parameters('kvName'), parameters('encryptionKeyName')), '2022-07-01').keyUriWithVersion), '/')))]"
                  }
                ]
              }
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgServicesName')), 'Microsoft.Resources/deployments', format('{0}-managedIdentityDeployment', parameters('solutionName')))]",
        "[subscriptionResourceId(parameters('subscriptionId'), 'Microsoft.Resources/deployments', format('{0}-resourceGroupsDeployment', parameters('solutionName')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('{0}-storageAccountDeployment', parameters('solutionName'))]",
      "resourceGroup": "[variables('rgStorageName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "solutionName": {
            "value": "[parameters('solutionName')]"
          },
          "solutionLocation": {
            "value": "[parameters('solutionLocation')]"
          },
          "saName": {
            "value": "[format('{0}sa', parameters('solutionName'))]"
          },
          "managedIdentityId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgServicesName')), 'Microsoft.Resources/deployments', format('{0}-managedIdentityDeployment', parameters('solutionName'))), '2025-04-01').outputs.managedIdentityOutput.value.id]"
          },
          "keyName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgStorageName')), 'Microsoft.Resources/deployments', format('{0}-keyvaultDeployment', parameters('solutionName'))), '2025-04-01').outputs.keyvaultOutput.value.keys[0].name]"
          },
          "keyVersion": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgStorageName')), 'Microsoft.Resources/deployments', format('{0}-keyvaultDeployment', parameters('solutionName'))), '2025-04-01').outputs.keyvaultOutput.value.keys[0].version]"
          },
          "keyVaultUri": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgStorageName')), 'Microsoft.Resources/deployments', format('{0}-keyvaultDeployment', parameters('solutionName'))), '2025-04-01').outputs.keyvaultOutput.value.uri]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "7522621562344042066"
            }
          },
          "parameters": {
            "solutionName": {
              "type": "string",
              "minLength": 3,
              "maxLength": 15,
              "metadata": {
                "description": "Solution Name"
              }
            },
            "solutionLocation": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Solution Location"
              }
            },
            "skuName": {
              "type": "string",
              "defaultValue": "Standard_LRS",
              "allowedValues": [
                "Premium_LRS",
                "Premium_ZRS",
                "Standard_GRS",
                "Standard_GZRS",
                "Standard_LRS",
                "Standard_RAGRS",
                "Standard_RAGZRS",
                "Standard_ZRS"
              ],
              "metadata": {
                "description": "SKU Name. The SKU name. Required for account creation; optional for update. Note that in older versions, SKU name was called accountType."
              }
            },
            "skuTier": {
              "type": "string",
              "defaultValue": "Standard",
              "allowedValues": [
                "Premium",
                "Standard"
              ],
              "metadata": {
                "description": "SKU Tier. The SKU name. Required for account creation; optional for update. Note that in older versions, SKU name was called accountType."
              }
            },
            "saName": {
              "type": "string",
              "defaultValue": "[format('{0}sa', parameters('solutionName'))]",
              "metadata": {
                "description": "Name"
              }
            },
            "managedIdentityId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Managed Identity Id. Resource identifier of the UserAssigned identity to be used for the storage account deploymend and associated with server-side encryption on the storage account."
              }
            },
            "keyName": {
              "type": "string",
              "defaultValue": "encryptionKey",
              "metadata": {
                "description": "Key Name. The name of KeyVault key."
              }
            },
            "keyVaultUri": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Key Vault URI. The Uri of KeyVault."
              }
            },
            "keyVersion": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Key Version. The version of KeyVault key."
              }
            },
            "allowBlobPublicAccess": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Allow Blob Public Access. Allow or disallow public access to all blobs or containers in the storage account. The default interpretation is true for this property."
              }
            },
            "isHnsEnabled": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Is HNS Enabled. Account HierarchicalNamespace enabled if sets to true."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2024-01-01",
              "name": "[parameters('saName')]",
              "location": "[parameters('solutionLocation')]",
              "sku": {
                "name": "[parameters('skuName')]",
                "tier": "[parameters('skuTier')]"
              },
              "kind": "StorageV2",
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', parameters('managedIdentityId'))]": {}
                }
              },
              "properties": {
                "minimumTlsVersion": "TLS1_2",
                "allowBlobPublicAccess": "[parameters('allowBlobPublicAccess')]",
                "isHnsEnabled": "[parameters('isHnsEnabled')]",
                "networkAcls": {
                  "bypass": "AzureServices",
                  "virtualNetworkRules": [],
                  "ipRules": [],
                  "defaultAction": "Allow"
                },
                "supportsHttpsTrafficOnly": true,
                "encryption": {
                  "identity": {
                    "userAssignedIdentity": "[parameters('managedIdentityId')]"
                  },
                  "services": {
                    "file": {
                      "keyType": "Account",
                      "enabled": true
                    },
                    "blob": {
                      "keyType": "Account",
                      "enabled": true
                    }
                  },
                  "keySource": "Microsoft.KeyVault",
                  "keyvaultproperties": {
                    "keyname": "[parameters('keyName')]",
                    "keyvaulturi": "[parameters('keyVaultUri')]",
                    "keyversion": "[parameters('keyVersion')]"
                  }
                }
              }
            },
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices",
              "apiVersion": "2024-01-01",
              "name": "[format('{0}/{1}', parameters('saName'), 'default')]",
              "properties": {
                "cors": {
                  "corsRules": []
                },
                "deleteRetentionPolicy": {
                  "allowPermanentDelete": true,
                  "enabled": true,
                  "days": 30
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('saName'))]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
              "apiVersion": "2024-01-01",
              "name": "[format('{0}/{1}/{2}', parameters('saName'), 'default', 'filesys')]",
              "properties": {
                "defaultEncryptionScope": "$account-encryption-key",
                "denyEncryptionScopeOverride": false,
                "publicAccess": "None"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/blobServices', parameters('saName'), 'default')]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
              "apiVersion": "2024-01-01",
              "name": "[format('{0}/{1}/{2}', parameters('saName'), 'default', 'public')]",
              "properties": {
                "defaultEncryptionScope": "$account-encryption-key",
                "denyEncryptionScopeOverride": false,
                "publicAccess": "Blob"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/blobServices', parameters('saName'), 'default')]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/fileServices",
              "apiVersion": "2024-01-01",
              "name": "[format('{0}/{1}', parameters('saName'), 'default')]",
              "properties": {
                "cors": {
                  "corsRules": []
                },
                "shareDeleteRetentionPolicy": {
                  "allowPermanentDelete": true,
                  "days": 60,
                  "enabled": true
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('saName'))]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/fileServices/shares",
              "apiVersion": "2024-01-01",
              "name": "[format('{0}/{1}/{2}', parameters('saName'), 'default', 'containerinstance')]",
              "properties": {
                "accessTier": "cool",
                "enabledProtocols": "SMB",
                "metadata": {},
                "shareQuota": 8
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/fileServices', parameters('saName'), 'default')]"
              ]
            }
          ],
          "outputs": {
            "storageAccountOutput": {
              "type": "object",
              "value": {
                "id": "[resourceId('Microsoft.Storage/storageAccounts', parameters('saName'))]",
                "name": "[parameters('saName')]",
                "sku": "[parameters('skuName')]",
                "uri": "[reference(resourceId('Microsoft.Storage/storageAccounts', parameters('saName')), '2024-01-01').primaryEndpoints.web]",
                "dfs": "[reference(resourceId('Microsoft.Storage/storageAccounts', parameters('saName')), '2024-01-01').primaryEndpoints.dfs]",
                "storageAccountName": "[parameters('saName')]",
                "key": "[listKeys(resourceId('Microsoft.Storage/storageAccounts', parameters('saName')), '2024-01-01').keys[0].value]",
                "connectionString": "[format('DefaultEndpointsProtocol=https;AccountName={0};AccountKey={1};EndpointSuffix={2}', parameters('saName'), listKeys(resourceId('Microsoft.Storage/storageAccounts', parameters('saName')), '2024-01-01').keys[0].value, environment().suffixes.storage)]",
                "dataContainer": "default",
                "blobs": [
                  {
                    "id": "[resourceId('Microsoft.Storage/storageAccounts/blobServices/containers', parameters('saName'), 'default', 'public')]",
                    "name": "public"
                  }
                ],
                "shares": [
                  {
                    "id": "[resourceId('Microsoft.Storage/storageAccounts/fileServices/shares', parameters('saName'), 'default', 'containerinstance')]",
                    "name": "containerinstance"
                  }
                ]
              }
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgStorageName')), 'Microsoft.Resources/deployments', format('{0}-keyvaultDeployment', parameters('solutionName')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgServicesName')), 'Microsoft.Resources/deployments', format('{0}-managedIdentityDeployment', parameters('solutionName')))]",
        "[subscriptionResourceId(parameters('subscriptionId'), 'Microsoft.Resources/deployments', format('{0}-resourceGroupsDeployment', parameters('solutionName')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('{0}-storageAccountDeploymentForMLWS', parameters('solutionName'))]",
      "resourceGroup": "[variables('rgStorageName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "saName": {
            "value": "[format('{0}samlws', parameters('solutionName'))]"
          },
          "solutionName": {
            "value": "[parameters('solutionName')]"
          },
          "solutionLocation": {
            "value": "[parameters('solutionLocation')]"
          },
          "managedIdentityId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgServicesName')), 'Microsoft.Resources/deployments', format('{0}-managedIdentityDeployment', parameters('solutionName'))), '2025-04-01').outputs.managedIdentityOutput.value.id]"
          },
          "keyName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgStorageName')), 'Microsoft.Resources/deployments', format('{0}-keyvaultDeployment', parameters('solutionName'))), '2025-04-01').outputs.keyvaultOutput.value.keys[0].name]"
          },
          "keyVersion": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgStorageName')), 'Microsoft.Resources/deployments', format('{0}-keyvaultDeployment', parameters('solutionName'))), '2025-04-01').outputs.keyvaultOutput.value.keys[0].version]"
          },
          "keyVaultUri": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgStorageName')), 'Microsoft.Resources/deployments', format('{0}-keyvaultDeployment', parameters('solutionName'))), '2025-04-01').outputs.keyvaultOutput.value.uri]"
          },
          "isHnsEnabled": {
            "value": false
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "7522621562344042066"
            }
          },
          "parameters": {
            "solutionName": {
              "type": "string",
              "minLength": 3,
              "maxLength": 15,
              "metadata": {
                "description": "Solution Name"
              }
            },
            "solutionLocation": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Solution Location"
              }
            },
            "skuName": {
              "type": "string",
              "defaultValue": "Standard_LRS",
              "allowedValues": [
                "Premium_LRS",
                "Premium_ZRS",
                "Standard_GRS",
                "Standard_GZRS",
                "Standard_LRS",
                "Standard_RAGRS",
                "Standard_RAGZRS",
                "Standard_ZRS"
              ],
              "metadata": {
                "description": "SKU Name. The SKU name. Required for account creation; optional for update. Note that in older versions, SKU name was called accountType."
              }
            },
            "skuTier": {
              "type": "string",
              "defaultValue": "Standard",
              "allowedValues": [
                "Premium",
                "Standard"
              ],
              "metadata": {
                "description": "SKU Tier. The SKU name. Required for account creation; optional for update. Note that in older versions, SKU name was called accountType."
              }
            },
            "saName": {
              "type": "string",
              "defaultValue": "[format('{0}sa', parameters('solutionName'))]",
              "metadata": {
                "description": "Name"
              }
            },
            "managedIdentityId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Managed Identity Id. Resource identifier of the UserAssigned identity to be used for the storage account deploymend and associated with server-side encryption on the storage account."
              }
            },
            "keyName": {
              "type": "string",
              "defaultValue": "encryptionKey",
              "metadata": {
                "description": "Key Name. The name of KeyVault key."
              }
            },
            "keyVaultUri": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Key Vault URI. The Uri of KeyVault."
              }
            },
            "keyVersion": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Key Version. The version of KeyVault key."
              }
            },
            "allowBlobPublicAccess": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Allow Blob Public Access. Allow or disallow public access to all blobs or containers in the storage account. The default interpretation is true for this property."
              }
            },
            "isHnsEnabled": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Is HNS Enabled. Account HierarchicalNamespace enabled if sets to true."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2024-01-01",
              "name": "[parameters('saName')]",
              "location": "[parameters('solutionLocation')]",
              "sku": {
                "name": "[parameters('skuName')]",
                "tier": "[parameters('skuTier')]"
              },
              "kind": "StorageV2",
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', parameters('managedIdentityId'))]": {}
                }
              },
              "properties": {
                "minimumTlsVersion": "TLS1_2",
                "allowBlobPublicAccess": "[parameters('allowBlobPublicAccess')]",
                "isHnsEnabled": "[parameters('isHnsEnabled')]",
                "networkAcls": {
                  "bypass": "AzureServices",
                  "virtualNetworkRules": [],
                  "ipRules": [],
                  "defaultAction": "Allow"
                },
                "supportsHttpsTrafficOnly": true,
                "encryption": {
                  "identity": {
                    "userAssignedIdentity": "[parameters('managedIdentityId')]"
                  },
                  "services": {
                    "file": {
                      "keyType": "Account",
                      "enabled": true
                    },
                    "blob": {
                      "keyType": "Account",
                      "enabled": true
                    }
                  },
                  "keySource": "Microsoft.KeyVault",
                  "keyvaultproperties": {
                    "keyname": "[parameters('keyName')]",
                    "keyvaulturi": "[parameters('keyVaultUri')]",
                    "keyversion": "[parameters('keyVersion')]"
                  }
                }
              }
            },
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices",
              "apiVersion": "2024-01-01",
              "name": "[format('{0}/{1}', parameters('saName'), 'default')]",
              "properties": {
                "cors": {
                  "corsRules": []
                },
                "deleteRetentionPolicy": {
                  "allowPermanentDelete": true,
                  "enabled": true,
                  "days": 30
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('saName'))]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
              "apiVersion": "2024-01-01",
              "name": "[format('{0}/{1}/{2}', parameters('saName'), 'default', 'filesys')]",
              "properties": {
                "defaultEncryptionScope": "$account-encryption-key",
                "denyEncryptionScopeOverride": false,
                "publicAccess": "None"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/blobServices', parameters('saName'), 'default')]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
              "apiVersion": "2024-01-01",
              "name": "[format('{0}/{1}/{2}', parameters('saName'), 'default', 'public')]",
              "properties": {
                "defaultEncryptionScope": "$account-encryption-key",
                "denyEncryptionScopeOverride": false,
                "publicAccess": "Blob"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/blobServices', parameters('saName'), 'default')]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/fileServices",
              "apiVersion": "2024-01-01",
              "name": "[format('{0}/{1}', parameters('saName'), 'default')]",
              "properties": {
                "cors": {
                  "corsRules": []
                },
                "shareDeleteRetentionPolicy": {
                  "allowPermanentDelete": true,
                  "days": 60,
                  "enabled": true
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('saName'))]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/fileServices/shares",
              "apiVersion": "2024-01-01",
              "name": "[format('{0}/{1}/{2}', parameters('saName'), 'default', 'containerinstance')]",
              "properties": {
                "accessTier": "cool",
                "enabledProtocols": "SMB",
                "metadata": {},
                "shareQuota": 8
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/fileServices', parameters('saName'), 'default')]"
              ]
            }
          ],
          "outputs": {
            "storageAccountOutput": {
              "type": "object",
              "value": {
                "id": "[resourceId('Microsoft.Storage/storageAccounts', parameters('saName'))]",
                "name": "[parameters('saName')]",
                "sku": "[parameters('skuName')]",
                "uri": "[reference(resourceId('Microsoft.Storage/storageAccounts', parameters('saName')), '2024-01-01').primaryEndpoints.web]",
                "dfs": "[reference(resourceId('Microsoft.Storage/storageAccounts', parameters('saName')), '2024-01-01').primaryEndpoints.dfs]",
                "storageAccountName": "[parameters('saName')]",
                "key": "[listKeys(resourceId('Microsoft.Storage/storageAccounts', parameters('saName')), '2024-01-01').keys[0].value]",
                "connectionString": "[format('DefaultEndpointsProtocol=https;AccountName={0};AccountKey={1};EndpointSuffix={2}', parameters('saName'), listKeys(resourceId('Microsoft.Storage/storageAccounts', parameters('saName')), '2024-01-01').keys[0].value, environment().suffixes.storage)]",
                "dataContainer": "default",
                "blobs": [
                  {
                    "id": "[resourceId('Microsoft.Storage/storageAccounts/blobServices/containers', parameters('saName'), 'default', 'public')]",
                    "name": "public"
                  }
                ],
                "shares": [
                  {
                    "id": "[resourceId('Microsoft.Storage/storageAccounts/fileServices/shares', parameters('saName'), 'default', 'containerinstance')]",
                    "name": "containerinstance"
                  }
                ]
              }
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgStorageName')), 'Microsoft.Resources/deployments', format('{0}-keyvaultDeployment', parameters('solutionName')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgServicesName')), 'Microsoft.Resources/deployments', format('{0}-managedIdentityDeployment', parameters('solutionName')))]",
        "[subscriptionResourceId(parameters('subscriptionId'), 'Microsoft.Resources/deployments', format('{0}-resourceGroupsDeployment', parameters('solutionName')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('{0}-containerRegistryDeployment', parameters('solutionName'))]",
      "resourceGroup": "[variables('rgStorageName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "solutionName": {
            "value": "[parameters('solutionName')]"
          },
          "solutionLocation": {
            "value": "[parameters('solutionLocation')]"
          },
          "armAudienceTokenPolicyStatus": {
            "value": "Enabled"
          },
          "sku": {
            "value": "Premium"
          },
          "managedIdentityId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgServicesName')), 'Microsoft.Resources/deployments', format('{0}-managedIdentityDeployment', parameters('solutionName'))), '2025-04-01').outputs.managedIdentityOutput.value.id]"
          },
          "managedIdentityPrincipalId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgServicesName')), 'Microsoft.Resources/deployments', format('{0}-managedIdentityDeployment', parameters('solutionName'))), '2025-04-01').outputs.managedIdentityOutput.value.objectId]"
          },
          "keyVaultIdentity": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgServicesName')), 'Microsoft.Resources/deployments', format('{0}-managedIdentityDeployment', parameters('solutionName'))), '2025-04-01').outputs.managedIdentityOutput.value.clientId]"
          },
          "keyVaultKeyIdentifier": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgStorageName')), 'Microsoft.Resources/deployments', format('{0}-keyvaultDeployment', parameters('solutionName'))), '2025-04-01').outputs.keyvaultOutput.value.keys[0].uri]"
          },
          "keyVaultStatus": {
            "value": "Enabled"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "17966058211850413555"
            }
          },
          "parameters": {
            "solutionName": {
              "type": "string",
              "minLength": 3,
              "maxLength": 15,
              "metadata": {
                "description": "Solution Name"
              }
            },
            "solutionLocation": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Solution Location"
              }
            },
            "crName": {
              "type": "string",
              "defaultValue": "[format('{0}cr', parameters('solutionName'))]",
              "metadata": {
                "description": "Name"
              }
            },
            "sku": {
              "type": "string",
              "defaultValue": "Premium",
              "allowedValues": [
                "Basic",
                "Standard",
                "Premium"
              ],
              "metadata": {
                "description": "SKU"
              }
            },
            "identityType": {
              "type": "string",
              "defaultValue": "UserAssigned",
              "allowedValues": [
                "None",
                "SystemAssigned",
                "UserAssigned"
              ],
              "metadata": {
                "description": "Managed Identity Type. "
              }
            },
            "managedIdentityId": {
              "type": "string",
              "metadata": {
                "description": "Managed Identity ID. The resource identifier of the UserAssigned identity to be used for the container registry deployment."
              }
            },
            "managedIdentityPrincipalId": {
              "type": "string",
              "metadata": {
                "description": "Managed Identity Principal ID. The principal id of the UserAssigned identity to be used for the container registry deployment."
              }
            },
            "adminUserEnabled": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Admin User Enabled. The value that indicates whether the admin user is enabled."
              }
            },
            "anonymousPullEnabled": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Anonymous Pull Enabled"
              }
            },
            "dataEndPointEnabled": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Data EndPoint Enabled. Enables registry-wide pull from unauthenticated clients."
              }
            },
            "keyVaultIdentity": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Key Vault Identity. The client id of the identity which will be used to access key vault."
              }
            },
            "keyVaultKeyIdentifier": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Key Vault Key Identifier. Key vault uri to access the encryption key."
              }
            },
            "keyVaultStatus": {
              "type": "string",
              "defaultValue": "Disabled",
              "allowedValues": [
                "Enabled",
                "Disabled"
              ],
              "metadata": {
                "description": "Key Vault Status. Indicates whether or not the encryption is enabled for container registry."
              }
            },
            "armAudienceTokenPolicyStatus": {
              "type": "string",
              "defaultValue": "Enabled",
              "allowedValues": [
                "Enabled",
                "Disabled"
              ],
              "metadata": {
                "description": "ARM Audience Token Policy Status. The policy for using ARM audience token for a container registry. Status is the value that indicates whether the policy is enabled or not."
              }
            },
            "exportPolicyStatus": {
              "type": "string",
              "defaultValue": "Enabled",
              "allowedValues": [
                "Enabled",
                "Disabled"
              ],
              "metadata": {
                "description": "Export Policy Status. The export policy for a container registry.\tStatus is the value that indicates whether the policy is enabled or not."
              }
            },
            "quarantinePolicyStatus": {
              "type": "string",
              "defaultValue": "Disabled",
              "allowedValues": [
                "Enabled",
                "Disabled"
              ],
              "metadata": {
                "description": "Quarantine Policy Status. The quarantine policy for a container registry. Status is the value that indicates whether the policy is enabled or not."
              }
            },
            "retentionPolicyStatus": {
              "type": "string",
              "defaultValue": "Disabled",
              "allowedValues": [
                "Enabled",
                "Disabled"
              ],
              "metadata": {
                "description": "Retetion Policy Status. The retention policy for a container registry. Status is the value that indicates whether the policy is enabled or not."
              }
            },
            "retentionPolicyDays": {
              "type": "int",
              "defaultValue": 30,
              "metadata": {
                "description": "Retetion Policy Datys. The retention policy for a container registry. Days is the number of days to retain an untagged manifest after which it gets purged."
              }
            },
            "softDeletePolicyRetentionDays": {
              "type": "int",
              "defaultValue": 30,
              "metadata": {
                "description": "Soft Delete Policy Retention Days. The soft delete policy for a container registry. Retention Days is the number of days after which a soft-deleted item is permanently deleted."
              }
            },
            "softDeletePolicyStatus": {
              "type": "string",
              "defaultValue": "Disabled",
              "allowedValues": [
                "Enabled",
                "Disabled"
              ],
              "metadata": {
                "description": "Soft Delete Policy Status. The soft delete policy for a container registry. Status is the value that indicates whether the policy is enabled or not."
              }
            },
            "trustPolicyStatus": {
              "type": "string",
              "defaultValue": "Disabled",
              "allowedValues": [
                "Enabled",
                "Disabled"
              ],
              "metadata": {
                "description": "Trust Policy Status. The soft delete policy for a container registry. Status is the value that indicates whether the policy is enabled or not."
              }
            },
            "trustPolicyType": {
              "type": "string",
              "defaultValue": "Notary",
              "metadata": {
                "description": "Trust Policy Type. The content trust policy for a container registry. The type of trust policy."
              }
            },
            "publicNetworkAccess": {
              "type": "string",
              "defaultValue": "Enabled",
              "allowedValues": [
                "Enabled",
                "Disabled"
              ],
              "metadata": {
                "description": "Public Network Access. Whether or not public network access is allowed for the container registry."
              }
            },
            "zoneRedundancy": {
              "type": "string",
              "defaultValue": "Disabled",
              "allowedValues": [
                "Enabled",
                "Disabled"
              ],
              "metadata": {
                "description": "Zone Redundancy. Whether or not zone redundancy is enabled for this container registry."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.ContainerRegistry/registries",
              "apiVersion": "2025-05-01-preview",
              "name": "[parameters('crName')]",
              "location": "[parameters('solutionLocation')]",
              "tags": {
                "app": "[parameters('solutionName')]",
                "location": "[parameters('solutionLocation')]"
              },
              "sku": {
                "name": "[parameters('sku')]"
              },
              "identity": {
                "type": "[parameters('identityType')]",
                "userAssignedIdentities": {
                  "[format('{0}', parameters('managedIdentityId'))]": {}
                }
              },
              "properties": {
                "adminUserEnabled": "[parameters('adminUserEnabled')]",
                "anonymousPullEnabled": "[parameters('anonymousPullEnabled')]",
                "dataEndpointEnabled": "[parameters('dataEndPointEnabled')]",
                "encryption": {
                  "keyVaultProperties": {
                    "identity": "[parameters('keyVaultIdentity')]",
                    "keyIdentifier": "[parameters('keyVaultKeyIdentifier')]"
                  },
                  "status": "[parameters('keyVaultStatus')]"
                },
                "policies": {
                  "azureADAuthenticationAsArmPolicy": {
                    "status": "[parameters('armAudienceTokenPolicyStatus')]"
                  },
                  "exportPolicy": {
                    "status": "[parameters('exportPolicyStatus')]"
                  },
                  "quarantinePolicy": {
                    "status": "[parameters('quarantinePolicyStatus')]"
                  },
                  "retentionPolicy": {
                    "days": "[parameters('retentionPolicyDays')]",
                    "status": "[parameters('retentionPolicyStatus')]"
                  },
                  "softDeletePolicy": {
                    "retentionDays": "[parameters('softDeletePolicyRetentionDays')]",
                    "status": "[parameters('softDeletePolicyStatus')]"
                  },
                  "trustPolicy": {
                    "status": "[parameters('trustPolicyStatus')]",
                    "type": "[parameters('trustPolicyType')]"
                  }
                },
                "publicNetworkAccess": "[parameters('publicNetworkAccess')]",
                "zoneRedundancy": "[parameters('zoneRedundancy')]"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.ContainerRegistry/registries/{0}', parameters('crName'))]",
              "name": "[guid(resourceId('Microsoft.ContainerRegistry/registries', parameters('crName')), parameters('managedIdentityPrincipalId'), 'AcrPull')]",
              "properties": {
                "principalId": "[parameters('managedIdentityPrincipalId')]",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '7f951dda-4ed3-4680-a7ca-43fe172d538d')]",
                "principalType": "ServicePrincipal"
              },
              "dependsOn": [
                "[resourceId('Microsoft.ContainerRegistry/registries', parameters('crName'))]"
              ]
            }
          ],
          "outputs": {
            "containerRegistryOutput": {
              "type": "object",
              "value": {
                "id": "[resourceId('Microsoft.ContainerRegistry/registries', parameters('crName'))]",
                "name": "[parameters('crName')]"
              }
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgStorageName')), 'Microsoft.Resources/deployments', format('{0}-keyvaultDeployment', parameters('solutionName')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgServicesName')), 'Microsoft.Resources/deployments', format('{0}-managedIdentityDeployment', parameters('solutionName')))]",
        "[subscriptionResourceId(parameters('subscriptionId'), 'Microsoft.Resources/deployments', format('{0}-resourceGroupsDeployment', parameters('solutionName')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('{0}-logAnalyticsWorkspaceDeployment', parameters('solutionName'))]",
      "resourceGroup": "[variables('rgAnalyticsName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "solutionName": {
            "value": "[parameters('solutionName')]"
          },
          "solutionLocation": {
            "value": "[parameters('solutionLocation')]"
          },
          "managedIdentityId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgServicesName')), 'Microsoft.Resources/deployments', format('{0}-managedIdentityDeployment', parameters('solutionName'))), '2025-04-01').outputs.managedIdentityOutput.value.id]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "9500061081597913762"
            }
          },
          "parameters": {
            "solutionName": {
              "type": "string",
              "minLength": 3,
              "maxLength": 15,
              "metadata": {
                "description": "Solution Name"
              }
            },
            "solutionLocation": {
              "type": "string",
              "metadata": {
                "description": "Solution Location"
              }
            },
            "lawsName": {
              "type": "string",
              "defaultValue": "[format('{0}-laws', parameters('solutionName'))]",
              "metadata": {
                "description": "Log Analytics Workspace Name"
              }
            },
            "identityType": {
              "type": "string",
              "defaultValue": "UserAssigned",
              "allowedValues": [
                "None",
                "SystemAssigned",
                "UserAssigned"
              ],
              "metadata": {
                "description": "Managed Identity Type. "
              }
            },
            "skuName": {
              "type": "string",
              "defaultValue": "PerGB2018",
              "allowedValues": [
                "CapacityReservation",
                "Free",
                "LACluster",
                "PerGB2018",
                "PerNode",
                "Premium",
                "Standalone",
                "Standard"
              ],
              "metadata": {
                "description": "SKU Name. The name of the SKU."
              }
            },
            "managedIdentityId": {
              "type": "string",
              "metadata": {
                "description": "Managed Identity Id. Resource identifier of the UserAssigned identity to be used for the Log Analytics Workspace."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/workspaces",
              "apiVersion": "2023-09-01",
              "name": "[parameters('lawsName')]",
              "location": "[parameters('solutionLocation')]",
              "tags": {
                "app": "[parameters('solutionName')]",
                "location": "[parameters('solutionLocation')]"
              },
              "identity": {
                "type": "[parameters('identityType')]",
                "userAssignedIdentities": {
                  "[format('{0}', parameters('managedIdentityId'))]": {}
                }
              },
              "properties": {
                "sku": {
                  "name": "[parameters('skuName')]"
                },
                "retentionInDays": 90,
                "workspaceCapping": {
                  "dailyQuotaGb": "[json('0.025')]"
                }
              }
            }
          ],
          "outputs": {
            "logAnalyticsWorkspaceOutput": {
              "type": "object",
              "value": {
                "id": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('lawsName'))]",
                "name": "[parameters('lawsName')]",
                "workspaceId": "[reference(resourceId('Microsoft.OperationalInsights/workspaces', parameters('lawsName')), '2023-09-01').customerId]",
                "workspaceKey": "[listKeys(resourceId('Microsoft.OperationalInsights/workspaces', parameters('lawsName')), '2023-09-01').primarySharedKey]"
              }
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgServicesName')), 'Microsoft.Resources/deployments', format('{0}-managedIdentityDeployment', parameters('solutionName')))]",
        "[subscriptionResourceId(parameters('subscriptionId'), 'Microsoft.Resources/deployments', format('{0}-resourceGroupsDeployment', parameters('solutionName')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('{0}-containerInstanceDeployment', parameters('solutionName'))]",
      "resourceGroup": "[variables('rgServicesName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "solutionName": {
            "value": "[parameters('solutionName')]"
          },
          "solutionLocation": {
            "value": "[parameters('solutionLocation')]"
          },
          "managedIdentityId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgServicesName')), 'Microsoft.Resources/deployments', format('{0}-managedIdentityDeployment', parameters('solutionName'))), '2025-04-01').outputs.managedIdentityOutput.value.id]"
          },
          "logAnalyticsWorkspaceResourceId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgAnalyticsName')), 'Microsoft.Resources/deployments', format('{0}-logAnalyticsWorkspaceDeployment', parameters('solutionName'))), '2025-04-01').outputs.logAnalyticsWorkspaceOutput.value.id]"
          },
          "logAnalyticsWorkspaceId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgAnalyticsName')), 'Microsoft.Resources/deployments', format('{0}-logAnalyticsWorkspaceDeployment', parameters('solutionName'))), '2025-04-01').outputs.logAnalyticsWorkspaceOutput.value.workspaceId]"
          },
          "logAnalyticsWorkspaceKey": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgAnalyticsName')), 'Microsoft.Resources/deployments', format('{0}-logAnalyticsWorkspaceDeployment', parameters('solutionName'))), '2025-04-01').outputs.logAnalyticsWorkspaceOutput.value.workspaceKey]"
          },
          "encryptionKeyName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgStorageName')), 'Microsoft.Resources/deployments', format('{0}-keyvaultDeployment', parameters('solutionName'))), '2025-04-01').outputs.keyvaultOutput.value.keys[0].name]"
          },
          "encryptionKeyVersion": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgStorageName')), 'Microsoft.Resources/deployments', format('{0}-keyvaultDeployment', parameters('solutionName'))), '2025-04-01').outputs.keyvaultOutput.value.keys[0].version]"
          },
          "keyvaultBaseURL": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgStorageName')), 'Microsoft.Resources/deployments', format('{0}-keyvaultDeployment', parameters('solutionName'))), '2025-04-01').outputs.keyvaultOutput.value.uri]"
          },
          "storageAccountName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgStorageName')), 'Microsoft.Resources/deployments', format('{0}-storageAccountDeployment', parameters('solutionName'))), '2025-04-01').outputs.storageAccountOutput.value.name]"
          },
          "storageAccountKey": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgStorageName')), 'Microsoft.Resources/deployments', format('{0}-storageAccountDeployment', parameters('solutionName'))), '2025-04-01').outputs.storageAccountOutput.value.key]"
          },
          "azureFileShareName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgStorageName')), 'Microsoft.Resources/deployments', format('{0}-storageAccountDeployment', parameters('solutionName'))), '2025-04-01').outputs.storageAccountOutput.value.shares[0].name]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "15322702419360456373"
            }
          },
          "parameters": {
            "solutionName": {
              "type": "string",
              "minLength": 3,
              "maxLength": 15,
              "metadata": {
                "description": "Solution Name"
              }
            },
            "solutionLocation": {
              "type": "string",
              "metadata": {
                "description": "Solution Location"
              }
            },
            "ciName": {
              "type": "string",
              "defaultValue": "[format('{0}-ci', parameters('solutionName'))]",
              "metadata": {
                "description": "Name"
              }
            },
            "managedIdentityId": {
              "type": "string",
              "metadata": {
                "description": "Managed Identity ID. The resource identifier of the UserAssigned identity to be used for the container instance deployment."
              }
            },
            "containerImage": {
              "type": "string",
              "defaultValue": "mcr.microsoft.com/azuredeploymentscripts-powershell:az9.7",
              "metadata": {
                "description": "Container Image. The name of the image used to create the container instance.."
              }
            },
            "volumeMountsName": {
              "type": "string",
              "defaultValue": "filesharevolume",
              "metadata": {
                "description": "Volume Mounts Name. The name of the volume mount."
              }
            },
            "mountPath": {
              "type": "string",
              "defaultValue": "/mnt/azscripts/azscriptinput",
              "metadata": {
                "description": "Mount Path. The path within the container where the volume should be mounted. Must not contain colon (:)."
              }
            },
            "logAnalyticsLogType": {
              "type": "string",
              "defaultValue": "ContainerInsights",
              "allowedValues": [
                "ContainerInsights",
                "ContainerInstanceLogs"
              ],
              "metadata": {
                "description": "Log Analytics Log Type. The log type to be used."
              }
            },
            "logAnalyticsWorkspaceResourceId": {
              "type": "securestring",
              "metadata": {
                "description": "Log Analytics Workspace Resource Id. The workspace resource id for log analytics."
              }
            },
            "logAnalyticsWorkspaceId": {
              "type": "securestring",
              "metadata": {
                "description": "Log Analytics Workspace Id. The workspace id for log analytics."
              }
            },
            "logAnalyticsWorkspaceKey": {
              "type": "securestring",
              "metadata": {
                "description": "Log Analytics Workspace Key. The workspace key for log analytics."
              }
            },
            "encryptionKeyName": {
              "type": "string",
              "defaultValue": "encryptionKey",
              "metadata": {
                "description": "Encryption Key Name. The encryption key name."
              }
            },
            "encryptionKeyVersion": {
              "type": "string",
              "metadata": {
                "description": "Encryption Key Version. The encryption key version."
              }
            },
            "keyvaultBaseURL": {
              "type": "string",
              "metadata": {
                "description": "Keyvault Base URL. The keyvault base url."
              }
            },
            "osType": {
              "type": "string",
              "defaultValue": "Linux",
              "allowedValues": [
                "Linux",
                "Windows"
              ],
              "metadata": {
                "description": "OS Type. The operating system type required by the containers in the container group."
              }
            },
            "priority": {
              "type": "string",
              "defaultValue": "Regular",
              "allowedValues": [
                "Regular",
                "Spot"
              ],
              "metadata": {
                "description": "Priority. The priority of the container group."
              }
            },
            "restartPolicy": {
              "type": "string",
              "defaultValue": "OnFailure",
              "allowedValues": [
                "OnFailure",
                "Always",
                "Never"
              ],
              "metadata": {
                "description": "Restart Policy. Restart policy for all containers within the container group."
              }
            },
            "SKU": {
              "type": "string",
              "defaultValue": "Standard",
              "allowedValues": [
                "Confidential",
                "Dedicated",
                "Standard"
              ],
              "metadata": {
                "description": ""
              }
            },
            "volumeName": {
              "type": "string",
              "defaultValue": "filesharevolume",
              "metadata": {
                "description": "Volume Name. The name of the volume."
              }
            },
            "storageAccountName": {
              "type": "string",
              "metadata": {
                "description": "Storage Account Name. The name of the storage account that contains the Azure File share."
              }
            },
            "storageAccountKey": {
              "type": "securestring",
              "metadata": {
                "description": "Storage Account Key. The storage account access key used to access the Azure File share."
              }
            },
            "azureFileShareName": {
              "type": "string",
              "metadata": {
                "description": "Azure File Share Name. The name of the Azure File share to be mounted as a volume."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.ContainerInstance/containerGroups",
              "apiVersion": "2024-10-01-preview",
              "name": "[parameters('ciName')]",
              "location": "[parameters('solutionLocation')]",
              "tags": {
                "app": "[parameters('solutionName')]",
                "location": "[parameters('solutionLocation')]"
              },
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', parameters('managedIdentityId'))]": {}
                }
              },
              "properties": {
                "containers": [
                  {
                    "name": "[parameters('ciName')]",
                    "properties": {
                      "command": [
                        "/bin/sh",
                        "-c",
                        "pwsh -c \"Start-Sleep -Seconds 1800\""
                      ],
                      "image": "[parameters('containerImage')]",
                      "ports": [
                        {
                          "port": 80,
                          "protocol": "TCP"
                        }
                      ],
                      "resources": {
                        "limits": {
                          "cpu": 1,
                          "memoryInGB": "[json('2')]"
                        },
                        "requests": {
                          "cpu": 1,
                          "memoryInGB": "[json('2')]"
                        }
                      },
                      "volumeMounts": [
                        {
                          "name": "[parameters('volumeMountsName')]",
                          "mountPath": "[parameters('mountPath')]",
                          "readOnly": false
                        }
                      ]
                    }
                  }
                ],
                "diagnostics": {
                  "logAnalytics": {
                    "logType": "[parameters('logAnalyticsLogType')]",
                    "metadata": {},
                    "workspaceResourceId": "[parameters('logAnalyticsWorkspaceResourceId')]",
                    "workspaceId": "[parameters('logAnalyticsWorkspaceId')]",
                    "workspaceKey": "[parameters('logAnalyticsWorkspaceKey')]"
                  }
                },
                "encryptionProperties": {
                  "identity": "[parameters('managedIdentityId')]",
                  "keyName": "[parameters('encryptionKeyName')]",
                  "keyVersion": "[parameters('encryptionKeyVersion')]",
                  "vaultBaseUrl": "[parameters('keyvaultBaseURL')]"
                },
                "osType": "[parameters('osType')]",
                "priority": "[parameters('priority')]",
                "restartPolicy": "[parameters('restartPolicy')]",
                "sku": "[parameters('SKU')]",
                "volumes": [
                  {
                    "name": "[parameters('volumeName')]",
                    "azureFile": {
                      "storageAccountName": "[parameters('storageAccountName')]",
                      "storageAccountKey": "[parameters('storageAccountKey')]",
                      "shareName": "[parameters('azureFileShareName')]",
                      "readOnly": false
                    }
                  }
                ]
              }
            }
          ],
          "outputs": {
            "containerInstanceOutput": {
              "type": "object",
              "value": {
                "id": "[resourceId('Microsoft.ContainerInstance/containerGroups', parameters('ciName'))]",
                "name": "[parameters('ciName')]"
              }
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgStorageName')), 'Microsoft.Resources/deployments', format('{0}-containerRegistryDeployment', parameters('solutionName')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgStorageName')), 'Microsoft.Resources/deployments', format('{0}-keyvaultDeployment', parameters('solutionName')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgAnalyticsName')), 'Microsoft.Resources/deployments', format('{0}-logAnalyticsWorkspaceDeployment', parameters('solutionName')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgServicesName')), 'Microsoft.Resources/deployments', format('{0}-managedIdentityDeployment', parameters('solutionName')))]",
        "[subscriptionResourceId(parameters('subscriptionId'), 'Microsoft.Resources/deployments', format('{0}-resourceGroupsDeployment', parameters('solutionName')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgStorageName')), 'Microsoft.Resources/deployments', format('{0}-storageAccountDeployment', parameters('solutionName')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('{0}-applicationInsightsDeployment', parameters('solutionName'))]",
      "resourceGroup": "[variables('rgAnalyticsName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "solutionName": {
            "value": "[parameters('solutionName')]"
          },
          "solutionLocation": {
            "value": "[parameters('solutionLocation')]"
          },
          "workspaceResourceId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgAnalyticsName')), 'Microsoft.Resources/deployments', format('{0}-logAnalyticsWorkspaceDeployment', parameters('solutionName'))), '2025-04-01').outputs.logAnalyticsWorkspaceOutput.value.Id]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "16276248681274319168"
            }
          },
          "parameters": {
            "solutionName": {
              "type": "string",
              "minLength": 3,
              "maxLength": 15,
              "metadata": {
                "description": "Project Name"
              }
            },
            "solutionLocation": {
              "type": "string",
              "metadata": {
                "description": "Project Location"
              }
            },
            "aiName": {
              "type": "string",
              "defaultValue": "[format('{0}-ai', parameters('solutionName'))]",
              "metadata": {
                "description": "Name"
              }
            },
            "applicationType": {
              "type": "string",
              "defaultValue": "web",
              "allowedValues": [
                "other",
                "web"
              ],
              "metadata": {
                "description": "Application Type. Type of application being monitored."
              }
            },
            "workspaceResourceId": {
              "type": "string",
              "metadata": {
                "description": "Log Analytics Workspace Resource Id. Resource Id of the log analytics workspace which the data will be ingested to. This property is required to create an application with this API version."
              }
            },
            "disableIpMasking": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Disable IP Masking."
              }
            },
            "disableLocalAuth": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Disable Local Auth. Disable Non-AAD based auth."
              }
            },
            "ingestionMode": {
              "type": "string",
              "defaultValue": "LogAnalytics",
              "allowedValues": [
                "ApplicationInsights",
                "ApplicationInsightsWithDiagnosticSettings",
                "LogAnalytics"
              ],
              "metadata": {
                "description": "Ingestion Mode. Indicates the flow of the ingestion."
              }
            },
            "publicNetworkAccessForIngestion": {
              "type": "string",
              "defaultValue": "Enabled",
              "allowedValues": [
                "Enabled",
                "Disabled"
              ],
              "metadata": {
                "description": "Public Network Access for Ingestion. The network access type for accessing Application Insights ingestion."
              }
            },
            "publicNetworkAccessForQuery": {
              "type": "string",
              "defaultValue": "Enabled",
              "allowedValues": [
                "Enabled",
                "Disabled"
              ],
              "metadata": {
                "description": "Public Network Access for Query. The network access type for accessing Application Insights query."
              }
            },
            "retetionInDays": {
              "type": "int",
              "defaultValue": 90,
              "metadata": {
                "description": "Retention In Days. Retention period in days."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Insights/components",
              "apiVersion": "2020-02-02",
              "name": "[parameters('aiName')]",
              "location": "[parameters('solutionLocation')]",
              "kind": "web",
              "tags": {
                "app": "[parameters('solutionName')]",
                "location": "[parameters('solutionLocation')]"
              },
              "properties": {
                "Application_Type": "[parameters('applicationType')]",
                "WorkspaceResourceId": "[parameters('workspaceResourceId')]",
                "DisableIpMasking": "[parameters('disableIpMasking')]",
                "DisableLocalAuth": "[parameters('disableLocalAuth')]",
                "Flow_Type": "Bluefield",
                "IngestionMode": "[parameters('ingestionMode')]",
                "publicNetworkAccessForIngestion": "[parameters('publicNetworkAccessForIngestion')]",
                "publicNetworkAccessForQuery": "[parameters('publicNetworkAccessForQuery')]",
                "Request_Source": "rest",
                "RetentionInDays": "[parameters('retetionInDays')]",
                "SamplingPercentage": "[json('0.65')]"
              }
            }
          ],
          "outputs": {
            "applicationInsightsOutput": {
              "type": "object",
              "value": {
                "id": "[resourceId('Microsoft.Insights/components', parameters('aiName'))]",
                "name": "[parameters('aiName')]"
              }
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgAnalyticsName')), 'Microsoft.Resources/deployments', format('{0}-logAnalyticsWorkspaceDeployment', parameters('solutionName')))]",
        "[subscriptionResourceId(parameters('subscriptionId'), 'Microsoft.Resources/deployments', format('{0}-resourceGroupsDeployment', parameters('solutionName')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('{0}-kubernetesServicesDeployment', parameters('solutionName'))]",
      "resourceGroup": "[variables('rgServicesName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "solutionName": {
            "value": "[parameters('solutionName')]"
          },
          "solutionLocation": {
            "value": "[parameters('solutionLocation')]"
          },
          "dnsPrefix": {
            "value": "[parameters('solutionName')]"
          },
          "tenantId": {
            "value": "[parameters('tenantId')]"
          },
          "linuxAdminUsername": {
            "value": "[parameters('linuxAdminUserName')]"
          },
          "sshRSAPublicKey": {
            "value": "[parameters('sshRSAPublicKey')]"
          },
          "managedIdentityId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgServicesName')), 'Microsoft.Resources/deployments', format('{0}-managedIdentityDeployment', parameters('solutionName'))), '2025-04-01').outputs.managedIdentityOutput.value.id]"
          },
          "managedIdentityPrincipalId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgServicesName')), 'Microsoft.Resources/deployments', format('{0}-managedIdentityDeployment', parameters('solutionName'))), '2025-04-01').outputs.managedIdentityOutput.value.objectId]"
          },
          "enableAzureRBAC": {
            "value": true
          },
          "servicesSubnetId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNetworkName')), 'Microsoft.Resources/deployments', format('{0}-virtualNetworkDeployment', parameters('solutionName'))), '2025-04-01').outputs.virtualNetworkOutput.value.servicesSubnet.id]"
          },
          "orchestratorVersion": {
            "value": "1.32.7"
          },
          "keyId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgStorageName')), 'Microsoft.Resources/deployments', format('{0}-keyvaultDeployment', parameters('solutionName'))), '2025-04-01').outputs.keyvaultOutput.value.keys[0].uri]"
          },
          "keyVaultKmsEnabled": {
            "value": true
          },
          "defenderEnabled": {
            "value": true
          },
          "logAnalyticsWorkspaceResourceId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgAnalyticsName')), 'Microsoft.Resources/deployments', format('{0}-logAnalyticsWorkspaceDeployment', parameters('solutionName'))), '2025-04-01').outputs.logAnalyticsWorkspaceOutput.value.id]"
          },
          "webAppRoutingEnabled": {
            "value": true
          },
          "dnsZoneResourceId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNetworkName')), 'Microsoft.Resources/deployments', format('{0}-dnsZonesDeployment', parameters('solutionName'))), '2025-04-01').outputs.dnsZonesOutput.value.id]"
          },
          "appGatewayId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNetworkName')), 'Microsoft.Resources/deployments', format('{0}-appGatewayDeployment', parameters('solutionName'))), '2025-04-01').outputs.appGatewayOutput.value.id]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "2223283224317229191"
            }
          },
          "parameters": {
            "solutionName": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Solution Name."
              }
            },
            "solutionLocation": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Solution Location."
              }
            },
            "skuTier": {
              "type": "string",
              "defaultValue": "Free",
              "allowedValues": [
                "Free",
                "Standard",
                "Premium"
              ],
              "metadata": {
                "description": "SKU Tier. If not specified, the default is 'Free'."
              }
            },
            "managedIdentityId": {
              "type": "string",
              "metadata": {
                "description": "Managed Identity Id. The resource ID of the user assigned managed identity to be used by the AKS cluster."
              }
            },
            "managedIdentityPrincipalId": {
              "type": "string",
              "metadata": {
                "description": "Managed Identity Principal Id. The principal ID of the user assigned managed identity to be used by the AKS cluster."
              }
            },
            "dnsPrefix": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "DNS Prefix. Optional DNS prefix to use with hosted Kubernetes API server FQDN."
              }
            },
            "fqdnSubdomain": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "FQDN SubDomain. This cannot be updated once the Managed Cluster has been created."
              }
            },
            "enableAzureRBAC": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable Azure RBAC. Whether to enable Azure RBAC for Kubernetes authorization."
              }
            },
            "tenantId": {
              "type": "string",
              "defaultValue": "[subscription().tenantId]",
              "metadata": {
                "description": "Tenant Id. The AAD tenant ID to use for authentication. If not specified, will use the tenant of the deployment subscription."
              }
            },
            "servicesSubnetId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Service Subnet Id. If this is not specified, a vnet and subnet will be generated and used. If no podSubnetID is specified, this applies to nodes and pods, otherwise it applies to just nodes. This is of the form: /subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Network/virtualNetworks/{virtualNetworkName}/subnets/{subnetName}"
              }
            },
            "osDiskSizeGB": {
              "type": "int",
              "defaultValue": 128,
              "minValue": 0,
              "maxValue": 1023,
              "metadata": {
                "description": "OS Disk Size Gb. Disk size (in GB) to provision for each of the agent pool nodes. This value ranges from 0 to 1023. Specifying 0 will apply the default disk size for that agentVMSize."
              }
            },
            "agentCount": {
              "type": "int",
              "defaultValue": 1,
              "minValue": 1,
              "maxValue": 50,
              "metadata": {
                "description": "Agent Count. The number of nodes for the cluster."
              }
            },
            "agentVMSize": {
              "type": "string",
              "defaultValue": "standard_b2ms",
              "metadata": {
                "description": "The size of the Virtual Machine."
              }
            },
            "orchestratorVersion": {
              "type": "string",
              "defaultValue": "1.32.6",
              "metadata": {
                "description": "Orchestrator Version."
              }
            },
            "linuxAdminUsername": {
              "type": "string",
              "metadata": {
                "description": "Linux Admin Username. User name for the Linux Virtual Machines."
              }
            },
            "sshRSAPublicKey": {
              "type": "string",
              "metadata": {
                "description": "SSH-RSA Public Key. Configure all linux machines with the SSH RSA public key string. Your key should include three parts, for example 'ssh-rsa AAAAB...snip...UcyupgH azureuser@linuxvm'"
              }
            },
            "publicNetworkAccess": {
              "type": "string",
              "defaultValue": "Enabled",
              "allowedValues": [
                "Enabled",
                "Disabled"
              ],
              "metadata": {
                "description": "Public Network Access. Allow or deny public network access for AKS"
              }
            },
            "keyVaultKmsEnabled": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Azure KeyVault KMS Enabled. Whether to enable Azure Key Vault key management service. The default is false."
              }
            },
            "keyId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Key Id. Identifier of Azure Key Vault key."
              }
            },
            "keyVaultNetworkAccess": {
              "type": "string",
              "defaultValue": "Public",
              "allowedValues": [
                "Public",
                "Private"
              ],
              "metadata": {
                "description": "KeyVault Network Access. Network access of key vault. The possible values are Public and Private. Public means the key vault allows public access from all networks. Private means the key vault disables public access and enables private link. The default value is Public."
              }
            },
            "keyVaultResourceId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "KeyVault Resource Id. Resource ID of key vault. When keyVaultNetworkAccess is Private, this field is required and must be a valid resource ID. When keyVaultNetworkAccess is Public, leave the field empty."
              }
            },
            "defenderEnabled": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Defender Enabled. Microsoft Defender settings for the security profile."
              }
            },
            "logAnalyticsWorkspaceResourceId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Log Analytics Workspace Resource Id. Resource ID of the Log Analytics workspace to be associated with Microsoft Defender. When Microsoft Defender is enabled, this field is required and must be a valid workspace resource ID. When Microsoft Defender is disabled, leave the field empty."
              }
            },
            "webAppRoutingEnabled": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Web App Routing Enabled. Whether to enable Web App Routing."
              }
            },
            "dnsZoneResourceId": {
              "type": "string",
              "metadata": {
                "description": "DNS Zone Resource Id. Resource ID of the DNS Zone to be associated with the web app. Used only when Web App Routing is enabled."
              }
            },
            "appGatewayId": {
              "type": "string",
              "metadata": {
                "description": "Application Gateway Id. The resource ID of the Application Gateway to be used for ingress. This is required when using the Application Gateway Ingress Controller addon."
              }
            }
          },
          "variables": {
            "ksName": "[format('{0}-ks', parameters('solutionName'))]"
          },
          "resources": [
            {
              "type": "Microsoft.ContainerService/managedClusters",
              "apiVersion": "2025-03-02-preview",
              "name": "[variables('ksName')]",
              "location": "[parameters('solutionLocation')]",
              "tags": {
                "app": "[parameters('solutionName')]",
                "location": "[parameters('solutionLocation')]"
              },
              "sku": {
                "name": "Base",
                "tier": "[parameters('skuTier')]"
              },
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', parameters('managedIdentityId'))]": {}
                }
              },
              "properties": {
                "dnsPrefix": "[parameters('dnsPrefix')]",
                "fqdnSubdomain": "[parameters('fqdnSubdomain')]",
                "aadProfile": {
                  "enableAzureRBAC": "[parameters('enableAzureRBAC')]",
                  "managed": true,
                  "tenantID": "[parameters('tenantId')]"
                },
                "agentPoolProfiles": [
                  {
                    "vnetSubnetID": "[parameters('servicesSubnetId')]",
                    "name": "agentpool",
                    "osDiskType": "Managed",
                    "osDiskSizeGB": "[parameters('osDiskSizeGB')]",
                    "count": "[parameters('agentCount')]",
                    "vmSize": "[parameters('agentVMSize')]",
                    "osType": "Linux",
                    "mode": "System",
                    "kubeletDiskType": "OS",
                    "maxPods": 110,
                    "type": "VirtualMachineScaleSets",
                    "maxCount": 3,
                    "minCount": 1,
                    "enableAutoScaling": true,
                    "powerState": {
                      "code": "Running"
                    },
                    "orchestratorVersion": "[parameters('orchestratorVersion')]",
                    "upgradeSettings": {},
                    "enableFIPS": false
                  }
                ],
                "linuxProfile": {
                  "adminUsername": "[parameters('linuxAdminUsername')]",
                  "ssh": {
                    "publicKeys": [
                      {
                        "keyData": "[parameters('sshRSAPublicKey')]"
                      }
                    ]
                  }
                },
                "servicePrincipalProfile": {
                  "clientId": "[parameters('managedIdentityPrincipalId')]"
                },
                "publicNetworkAccess": "[parameters('publicNetworkAccess')]",
                "securityProfile": {
                  "azureKeyVaultKms": {
                    "enabled": "[parameters('keyVaultKmsEnabled')]",
                    "keyId": "[parameters('keyId')]",
                    "keyVaultNetworkAccess": "[parameters('keyVaultNetworkAccess')]",
                    "keyVaultResourceId": "[parameters('keyVaultResourceId')]"
                  },
                  "defender": {
                    "securityMonitoring": {
                      "enabled": "[parameters('defenderEnabled')]"
                    },
                    "logAnalyticsWorkspaceResourceId": "[parameters('logAnalyticsWorkspaceResourceId')]"
                  }
                },
                "networkProfile": {
                  "networkPlugin": "azure",
                  "networkPluginMode": "overlay",
                  "loadBalancerSku": "standard",
                  "outboundType": "userassignedNATGateway",
                  "serviceCidr": "10.0.0.0/16",
                  "dnsServiceIP": "10.0.0.10",
                  "podCidr": "10.10.0.0/16",
                  "natGatewayProfile": {
                    "idleTimeoutInMinutes": 5,
                    "managedOutboundIPProfile": {
                      "count": 1
                    }
                  },
                  "staticEgressGatewayProfile": {
                    "enabled": true
                  }
                },
                "addonProfiles": {
                  "ingressApplicationGateway": {
                    "enabled": true,
                    "config": {
                      "applicationGatewayId": "[parameters('appGatewayId')]"
                    }
                  }
                },
                "ingressProfile": {
                  "webAppRouting": {
                    "enabled": "[parameters('webAppRoutingEnabled')]",
                    "dnsZoneResourceIds": [
                      "[parameters('dnsZoneResourceId')]"
                    ]
                  }
                },
                "storageProfile": {
                  "diskCSIDriver": {
                    "enabled": true
                  },
                  "fileCSIDriver": {
                    "enabled": true
                  },
                  "snapshotController": {
                    "enabled": true
                  }
                },
                "oidcIssuerProfile": {
                  "enabled": false
                },
                "workloadAutoScalerProfile": {},
                "metricsProfile": {
                  "costAnalysis": {
                    "enabled": false
                  }
                }
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.ContainerService/managedClusters/{0}', variables('ksName'))]",
              "name": "[guid(parameters('managedIdentityId'), variables('ksName'), 'Azure Kubernetes Service RBAC Cluster Admin')]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'b1ff04bb-8a4e-4dc4-8eb5-8693973ce19b')]",
                "principalId": "[parameters('managedIdentityPrincipalId')]",
                "principalType": "ServicePrincipal"
              },
              "dependsOn": [
                "[resourceId('Microsoft.ContainerService/managedClusters', variables('ksName'))]"
              ]
            }
          ],
          "outputs": {
            "kubernetesServicesOutput": {
              "type": "object",
              "value": {
                "id": "[resourceId('Microsoft.ContainerService/managedClusters', variables('ksName'))]",
                "name": "[variables('ksName')]",
                "kubeletIdentityClientId": "[reference(resourceId('Microsoft.ContainerService/managedClusters', variables('ksName')), '2025-03-02-preview').addonProfiles.ingressApplicationGateway.identity.clientId]",
                "kubeletIdentityObjectId": "[reference(resourceId('Microsoft.ContainerService/managedClusters', variables('ksName')), '2025-03-02-preview').addonProfiles.ingressApplicationGateway.identity.objectId]"
              }
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNetworkName')), 'Microsoft.Resources/deployments', format('{0}-appGatewayDeployment', parameters('solutionName')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgStorageName')), 'Microsoft.Resources/deployments', format('{0}-containerRegistryDeployment', parameters('solutionName')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNetworkName')), 'Microsoft.Resources/deployments', format('{0}-dnsZonesDeployment', parameters('solutionName')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgStorageName')), 'Microsoft.Resources/deployments', format('{0}-keyvaultDeployment', parameters('solutionName')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgAnalyticsName')), 'Microsoft.Resources/deployments', format('{0}-logAnalyticsWorkspaceDeployment', parameters('solutionName')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgServicesName')), 'Microsoft.Resources/deployments', format('{0}-managedIdentityDeployment', parameters('solutionName')))]",
        "[subscriptionResourceId(parameters('subscriptionId'), 'Microsoft.Resources/deployments', format('{0}-resourceGroupsDeployment', parameters('solutionName')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNetworkName')), 'Microsoft.Resources/deployments', format('{0}-virtualNetworkDeployment', parameters('solutionName')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('{0}-agicReaderRoleAssignment', parameters('solutionName'))]",
      "resourceGroup": "[variables('rgNetworkName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "kubeletIdentityClientId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgServicesName')), 'Microsoft.Resources/deployments', format('{0}-kubernetesServicesDeployment', parameters('solutionName'))), '2025-04-01').outputs.kubernetesServicesOutput.value.kubeletIdentityClientId]"
          },
          "kubeletIdentityObjectId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgServicesName')), 'Microsoft.Resources/deployments', format('{0}-kubernetesServicesDeployment', parameters('solutionName'))), '2025-04-01').outputs.kubernetesServicesOutput.value.kubeletIdentityObjectId]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "11643498226258938815"
            }
          },
          "parameters": {
            "kubeletIdentityClientId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Kubelet Identity Client Id. The client ID of the user assigned identity to be used for kubelet identity."
              }
            },
            "kubeletIdentityObjectId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Kubelet Identity Object Id. The object ID of the user assigned identity to be used for kubelet identity."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "name": "[guid(parameters('kubeletIdentityClientId'), resourceGroup().name, 'Reader')]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'acdd72a7-3385-48ef-bd42-f606fba81ae7')]",
                "principalId": "[parameters('kubeletIdentityObjectId')]",
                "principalType": "ServicePrincipal"
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgServicesName')), 'Microsoft.Resources/deployments', format('{0}-kubernetesServicesDeployment', parameters('solutionName')))]",
        "[subscriptionResourceId(parameters('subscriptionId'), 'Microsoft.Resources/deployments', format('{0}-resourceGroupsDeployment', parameters('solutionName')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('{0}-agicContributorRoleAssignment', parameters('solutionName'))]",
      "resourceGroup": "[variables('rgNetworkName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "appGatewayName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNetworkName')), 'Microsoft.Resources/deployments', format('{0}-appGatewayDeployment', parameters('solutionName'))), '2025-04-01').outputs.appGatewayOutput.value.name]"
          },
          "kubeletIdentityClientId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgServicesName')), 'Microsoft.Resources/deployments', format('{0}-kubernetesServicesDeployment', parameters('solutionName'))), '2025-04-01').outputs.kubernetesServicesOutput.value.kubeletIdentityClientId]"
          },
          "kubeletIdentityObjectId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgServicesName')), 'Microsoft.Resources/deployments', format('{0}-kubernetesServicesDeployment', parameters('solutionName'))), '2025-04-01').outputs.kubernetesServicesOutput.value.kubeletIdentityObjectId]"
          },
          "appGatewaySubnetName": {
            "value": "[format('{0}/{1}', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNetworkName')), 'Microsoft.Resources/deployments', format('{0}-virtualNetworkDeployment', parameters('solutionName'))), '2025-04-01').outputs.virtualNetworkOutput.value.name, reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNetworkName')), 'Microsoft.Resources/deployments', format('{0}-virtualNetworkDeployment', parameters('solutionName'))), '2025-04-01').outputs.virtualNetworkOutput.value.appGatewaySubnet.name)]"
          },
          "servicesSubnetName": {
            "value": "[format('{0}/{1}', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNetworkName')), 'Microsoft.Resources/deployments', format('{0}-virtualNetworkDeployment', parameters('solutionName'))), '2025-04-01').outputs.virtualNetworkOutput.value.name, reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNetworkName')), 'Microsoft.Resources/deployments', format('{0}-virtualNetworkDeployment', parameters('solutionName'))), '2025-04-01').outputs.virtualNetworkOutput.value.servicesSubnet.name)]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "3275924348311877624"
            }
          },
          "parameters": {
            "kubeletIdentityClientId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Kubelet Identity Client Id. The client ID of the user assigned identity to be used for kubelet identity."
              }
            },
            "kubeletIdentityObjectId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Kubelet Identity Object Id. The object ID of the user assigned identity to be used for kubelet identity."
              }
            },
            "appGatewayName": {
              "type": "string",
              "metadata": {
                "description": "App Gateway Name. The name of the Application Gateway resource."
              }
            },
            "appGatewaySubnetName": {
              "type": "string",
              "defaultValue": "subnet-appgateway",
              "metadata": {
                "description": "App Gateway Subnet Name. The name of the subnet where the Application Gateway is deployed."
              }
            },
            "servicesSubnetName": {
              "type": "string",
              "defaultValue": "subnet-services",
              "metadata": {
                "description": "Services Subnet Name. The name of the subnet where the BackEnd services are deployed."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Network/applicationGateways/{0}', parameters('appGatewayName'))]",
              "name": "[guid(parameters('kubeletIdentityClientId'), resourceId('Microsoft.Network/applicationGateways', parameters('appGatewayName')), 'Contributor')]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'b24988ac-6180-42a0-ab88-20f7382dd24c')]",
                "principalId": "[parameters('kubeletIdentityObjectId')]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Network/virtualNetworks/{0}/subnets/{1}', split(parameters('appGatewaySubnetName'), '/')[0], split(parameters('appGatewaySubnetName'), '/')[1])]",
              "name": "[guid(parameters('kubeletIdentityClientId'), resourceId('Microsoft.Network/virtualNetworks/subnets', split(parameters('appGatewaySubnetName'), '/')[0], split(parameters('appGatewaySubnetName'), '/')[1]), 'Network Contributor')]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '4d97b98b-1d4f-4787-a291-c67834d212e7')]",
                "principalId": "[parameters('kubeletIdentityObjectId')]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Network/virtualNetworks/{0}/subnets/{1}', split(parameters('servicesSubnetName'), '/')[0], split(parameters('servicesSubnetName'), '/')[1])]",
              "name": "[guid(parameters('kubeletIdentityClientId'), resourceId('Microsoft.Network/virtualNetworks/subnets', split(parameters('servicesSubnetName'), '/')[0], split(parameters('servicesSubnetName'), '/')[1]), 'Network Contributor')]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '4d97b98b-1d4f-4787-a291-c67834d212e7')]",
                "principalId": "[parameters('kubeletIdentityObjectId')]",
                "principalType": "ServicePrincipal"
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNetworkName')), 'Microsoft.Resources/deployments', format('{0}-appGatewayDeployment', parameters('solutionName')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgServicesName')), 'Microsoft.Resources/deployments', format('{0}-kubernetesServicesDeployment', parameters('solutionName')))]",
        "[subscriptionResourceId(parameters('subscriptionId'), 'Microsoft.Resources/deployments', format('{0}-resourceGroupsDeployment', parameters('solutionName')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNetworkName')), 'Microsoft.Resources/deployments', format('{0}-virtualNetworkDeployment', parameters('solutionName')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('{0}-agicManagedIdentityOperatorRoleAssignment', parameters('solutionName'))]",
      "resourceGroup": "[variables('rgServicesName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "managedIdentityClientId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgServicesName')), 'Microsoft.Resources/deployments', format('{0}-managedIdentityDeployment', parameters('solutionName'))), '2025-04-01').outputs.managedIdentityOutput.value.id]"
          },
          "managedIdentityName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgServicesName')), 'Microsoft.Resources/deployments', format('{0}-managedIdentityDeployment', parameters('solutionName'))), '2025-04-01').outputs.managedIdentityOutput.value.name]"
          },
          "kubeletIdentityClientId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgServicesName')), 'Microsoft.Resources/deployments', format('{0}-kubernetesServicesDeployment', parameters('solutionName'))), '2025-04-01').outputs.kubernetesServicesOutput.value.kubeletIdentityClientId]"
          },
          "kubeletIdentityObjectId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgServicesName')), 'Microsoft.Resources/deployments', format('{0}-kubernetesServicesDeployment', parameters('solutionName'))), '2025-04-01').outputs.kubernetesServicesOutput.value.kubeletIdentityObjectId]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "8911042136379795634"
            }
          },
          "parameters": {
            "managedIdentityClientId": {
              "type": "string",
              "metadata": {
                "description": "Managed Identity Client Id. The resource ID of the user assigned identity to be used for the deployment."
              }
            },
            "managedIdentityName": {
              "type": "string",
              "metadata": {
                "description": "Managed Identity Name. The name of the user assigned identity to be used for the deployment."
              }
            },
            "kubeletIdentityClientId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Kubelet Identity Client Id. The client ID of the user assigned identity to be used for kubelet identity."
              }
            },
            "kubeletIdentityObjectId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Kubelet Identity Object Id. The object ID of the user assigned identity to be used for kubelet identity."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.ManagedIdentity/userAssignedIdentities/{0}', parameters('managedIdentityName'))]",
              "name": "[guid(parameters('kubeletIdentityClientId'), parameters('managedIdentityClientId'), 'ManagedIdentityOperator')]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'f1a07417-d97a-45cb-824c-7a7467783830')]",
                "principalId": "[parameters('kubeletIdentityObjectId')]",
                "principalType": "ServicePrincipal"
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgServicesName')), 'Microsoft.Resources/deployments', format('{0}-kubernetesServicesDeployment', parameters('solutionName')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgServicesName')), 'Microsoft.Resources/deployments', format('{0}-managedIdentityDeployment', parameters('solutionName')))]",
        "[subscriptionResourceId(parameters('subscriptionId'), 'Microsoft.Resources/deployments', format('{0}-resourceGroupsDeployment', parameters('solutionName')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('{0}-sqlServerDeployment', parameters('solutionName'))]",
      "resourceGroup": "[variables('rgDataName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "solutionName": {
            "value": "[parameters('solutionName')]"
          },
          "solutionLocation": {
            "value": "[parameters('solutionLocation')]"
          },
          "managedIdentityId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgServicesName')), 'Microsoft.Resources/deployments', format('{0}-managedIdentityDeployment', parameters('solutionName'))), '2025-04-01').outputs.managedIdentityOutput.value.id]"
          },
          "sqlAdminUsername": {
            "value": "[parameters('sqlAdminLogin')]"
          },
          "sqlAdminPassword": {
            "value": "[parameters('sqlAdminPassword')]"
          },
          "dataEncryptionKeyURI": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgStorageName')), 'Microsoft.Resources/deployments', format('{0}-keyvaultDeployment', parameters('solutionName'))), '2025-04-01').outputs.keyvaultOutput.value.keys[0].uri]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "11033833523225131390"
            }
          },
          "parameters": {
            "solutionName": {
              "type": "string",
              "minLength": 3,
              "maxLength": 15,
              "metadata": {
                "description": "Solution Name"
              }
            },
            "solutionLocation": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Solution Location"
              }
            },
            "sqlServerName": {
              "type": "string",
              "defaultValue": "[format('{0}sql', parameters('solutionName'))]",
              "metadata": {
                "description": "SQL server Name"
              }
            },
            "identityType": {
              "type": "string",
              "defaultValue": "UserAssigned",
              "allowedValues": [
                "None",
                "SystemAssigned",
                "UserAssigned"
              ],
              "metadata": {
                "description": "Managed Identity Type. "
              }
            },
            "managedIdentityId": {
              "type": "string",
              "metadata": {
                "description": "Managed Identity ID. The resource ID of the user assigned identity to be used for the deployment."
              }
            },
            "sqlAdminUsername": {
              "type": "string",
              "metadata": {
                "description": "Administrator Login. The administrator's login name of a server. Can only be specified when the server is being created (and is required for creation)."
              }
            },
            "sqlAdminPassword": {
              "type": "securestring",
              "metadata": {
                "description": "Administrator Login Password. The administrator login password (required for server creation)."
              }
            },
            "isIPv6Enabled": {
              "type": "string",
              "defaultValue": "Disabled",
              "allowedValues": [
                "Enabled",
                "Disabled"
              ],
              "metadata": {
                "description": "Is IP V6 Enabled. Whether or not to enable IPv6 support for this server. Value is optional but if passed in, must be \"Enabled\" or \"Disabled\""
              }
            },
            "dataEncryptionKeyURI": {
              "type": "string",
              "metadata": {
                "description": "Data Encryption Key URI. A CMK URI of the key to use for encryption."
              }
            },
            "minimalTlsVersion": {
              "type": "string",
              "defaultValue": "1.2",
              "metadata": {
                "description": "Minimal TLS Version. Allowed values \"None\", \"1.0\", \"1.1\", \"1.2\", \"1.3\""
              }
            },
            "publicNetworkAccess": {
              "type": "string",
              "defaultValue": "Enabled",
              "allowedValues": [
                "Enabled",
                "Disabled",
                "SecuredByPerimeter"
              ],
              "metadata": {
                "description": "Public Network Access. Whether or not public endpoint access is allowed for this server. Value is optional but if passed in, must be \"Enabled\" or \"Disabled\" or \"SecuredByPerimeter\""
              }
            },
            "restrictOutboundNetworkAccess": {
              "type": "string",
              "defaultValue": "Disabled",
              "metadata": {
                "description": "Restrict Outbound Network Access. Whether or not to restrict outbound network access for this server. Value is optional but if passed in, must be \"Enabled\" or \"Disabled\""
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Sql/servers",
              "apiVersion": "2024-11-01-preview",
              "name": "[parameters('sqlServerName')]",
              "location": "[parameters('solutionLocation')]",
              "tags": {
                "app": "[parameters('solutionName')]",
                "location": "[parameters('solutionLocation')]"
              },
              "identity": {
                "type": "[parameters('identityType')]",
                "userAssignedIdentities": {
                  "[format('{0}', parameters('managedIdentityId'))]": {}
                }
              },
              "properties": {
                "administratorLogin": "[parameters('sqlAdminUsername')]",
                "administratorLoginPassword": "[parameters('sqlAdminPassword')]",
                "isIPv6Enabled": "[parameters('isIPv6Enabled')]",
                "keyId": "[parameters('dataEncryptionKeyURI')]",
                "minimalTlsVersion": "[parameters('minimalTlsVersion')]",
                "primaryUserAssignedIdentityId": "[parameters('managedIdentityId')]",
                "publicNetworkAccess": "[parameters('publicNetworkAccess')]",
                "restrictOutboundNetworkAccess": "[parameters('restrictOutboundNetworkAccess')]"
              }
            }
          ],
          "outputs": {
            "sqlServerOutput": {
              "type": "object",
              "value": {
                "id": "[resourceId('Microsoft.Sql/servers', parameters('sqlServerName'))]",
                "name": "[parameters('sqlServerName')]"
              }
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgStorageName')), 'Microsoft.Resources/deployments', format('{0}-keyvaultDeployment', parameters('solutionName')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgServicesName')), 'Microsoft.Resources/deployments', format('{0}-managedIdentityDeployment', parameters('solutionName')))]",
        "[subscriptionResourceId(parameters('subscriptionId'), 'Microsoft.Resources/deployments', format('{0}-resourceGroupsDeployment', parameters('solutionName')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('{0}-dataFactoryDeployment', parameters('solutionName'))]",
      "resourceGroup": "[variables('rgDataName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "solutionName": {
            "value": "[parameters('solutionName')]"
          },
          "solutionLocation": {
            "value": "[parameters('solutionLocation')]"
          },
          "managedIdentityId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgServicesName')), 'Microsoft.Resources/deployments', format('{0}-managedIdentityDeployment', parameters('solutionName'))), '2025-04-01').outputs.managedIdentityOutput.value.id]"
          },
          "encryptionKeyName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgStorageName')), 'Microsoft.Resources/deployments', format('{0}-keyvaultDeployment', parameters('solutionName'))), '2025-04-01').outputs.keyvaultOutput.value.keys[0].name]"
          },
          "encryptionKeyVersion": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgStorageName')), 'Microsoft.Resources/deployments', format('{0}-keyvaultDeployment', parameters('solutionName'))), '2025-04-01').outputs.keyvaultOutput.value.keys[0].version]"
          },
          "encryptionKeyVaultUri": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgStorageName')), 'Microsoft.Resources/deployments', format('{0}-keyvaultDeployment', parameters('solutionName'))), '2025-04-01').outputs.keyvaultOutput.value.uri]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "4732827365640590041"
            }
          },
          "parameters": {
            "solutionName": {
              "type": "string",
              "minLength": 3,
              "maxLength": 15,
              "metadata": {
                "description": "Solution Name"
              }
            },
            "solutionLocation": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Solution Location"
              }
            },
            "managedIdentityId": {
              "type": "string",
              "metadata": {
                "description": "Managed Identity Id. The Azure resource Id of the managed identity used for deployment."
              }
            },
            "publicNetworkAccess": {
              "type": "string",
              "defaultValue": "Disabled",
              "allowedValues": [
                "Enabled",
                "Disabled"
              ],
              "metadata": {
                "description": "Public Network Access. Whether or not public endpoint access is allowed for this data factory."
              }
            },
            "encryptionKeyName": {
              "type": "string",
              "defaultValue": "encryptionKey",
              "metadata": {
                "description": "Encryption Key Name. The name of KeyVault key."
              }
            },
            "encryptionKeyVersion": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Encryption Key Version. The version of KeyVault key."
              }
            },
            "encryptionKeyVaultUri": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Encryption Key Vault URI. The Uri of KeyVault."
              }
            },
            "dfName": {
              "type": "string",
              "defaultValue": "[format('{0}-df', parameters('solutionName'))]",
              "metadata": {
                "description": "Name"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.DataFactory/factories",
              "apiVersion": "2018-06-01",
              "name": "[parameters('dfName')]",
              "location": "[parameters('solutionLocation')]",
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', parameters('managedIdentityId'))]": {}
                }
              },
              "properties": {
                "encryption": {
                  "identity": {
                    "userAssignedIdentity": "[parameters('managedIdentityId')]"
                  },
                  "keyName": "[parameters('encryptionKeyName')]",
                  "keyVersion": "[parameters('encryptionKeyVersion')]",
                  "vaultBaseUrl": "[parameters('encryptionKeyVaultUri')]"
                },
                "publicNetworkAccess": "[parameters('publicNetworkAccess')]"
              }
            }
          ],
          "outputs": {
            "dataFactoryOutput": {
              "type": "object",
              "value": {
                "id": "[resourceId('Microsoft.DataFactory/factories', parameters('dfName'))]",
                "name": "[parameters('dfName')]"
              }
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgStorageName')), 'Microsoft.Resources/deployments', format('{0}-keyvaultDeployment', parameters('solutionName')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgServicesName')), 'Microsoft.Resources/deployments', format('{0}-managedIdentityDeployment', parameters('solutionName')))]",
        "[subscriptionResourceId(parameters('subscriptionId'), 'Microsoft.Resources/deployments', format('{0}-resourceGroupsDeployment', parameters('solutionName')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('{0}-machineLearningWorkspaceDeployment', parameters('solutionName'))]",
      "resourceGroup": "[variables('rgAIName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "solutionName": {
            "value": "[parameters('solutionName')]"
          },
          "solutionLocation": {
            "value": "[parameters('solutionLocation')]"
          },
          "managedIdentityId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgServicesName')), 'Microsoft.Resources/deployments', format('{0}-managedIdentityDeployment', parameters('solutionName'))), '2025-04-01').outputs.managedIdentityOutput.value.id]"
          },
          "keyVault": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgStorageName')), 'Microsoft.Resources/deployments', format('{0}-keyvaultDeployment', parameters('solutionName'))), '2025-04-01').outputs.keyvaultOutput.value.id]"
          },
          "storageAccount": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgStorageName')), 'Microsoft.Resources/deployments', format('{0}-storageAccountDeploymentForMLWS', parameters('solutionName'))), '2025-04-01').outputs.storageAccountOutput.value.id]"
          },
          "containerRegistry": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgStorageName')), 'Microsoft.Resources/deployments', format('{0}-containerRegistryDeployment', parameters('solutionName'))), '2025-04-01').outputs.containerRegistryOutput.value.id]"
          },
          "applicationInsights": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgAnalyticsName')), 'Microsoft.Resources/deployments', format('{0}-applicationInsightsDeployment', parameters('solutionName'))), '2025-04-01').outputs.applicationInsightsOutput.value.id]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "17819699656727421453"
            }
          },
          "parameters": {
            "solutionName": {
              "type": "string",
              "metadata": {
                "description": "Solution Name"
              }
            },
            "solutionLocation": {
              "type": "string",
              "metadata": {
                "description": "Solution Location"
              }
            },
            "mlwsName": {
              "type": "string",
              "defaultValue": "[format('{0}-mlws', parameters('solutionName'))]",
              "metadata": {
                "description": "ML Workspace Name"
              }
            },
            "managedIdentityId": {
              "type": "string",
              "metadata": {
                "description": "Managed Identity Id. The Azure resource Id of the managed identity used for the deployment."
              }
            },
            "storageAccount": {
              "type": "string",
              "metadata": {
                "description": "Storage Account. ARM id of the storage account associated with this workspace. This cannot be changed once the workspace has been created"
              }
            },
            "keyVault": {
              "type": "string",
              "metadata": {
                "description": "KeyVault. ARM id of the key vault associated with this workspace. This cannot be changed once the workspace has been created"
              }
            },
            "applicationInsights": {
              "type": "string",
              "metadata": {
                "description": "Application Insights. ARM id of the application insights associated with this workspace."
              }
            },
            "containerRegistry": {
              "type": "string",
              "metadata": {
                "description": "Container Registry. ARM id of the container registry associated with this workspace."
              }
            },
            "publicNetworkAccess": {
              "type": "string",
              "defaultValue": "Enabled",
              "allowedValues": [
                "Enabled",
                "Disabled"
              ],
              "metadata": {
                "description": "Public Network Access. Whether requests from Public Network are allowed."
              }
            },
            "skuName": {
              "type": "string",
              "defaultValue": "Basic",
              "metadata": {
                "description": "SKU Name. The name of the SKU. Ex - P3. It is typically a letter+number code."
              }
            },
            "skuTier": {
              "type": "string",
              "defaultValue": "Basic",
              "allowedValues": [
                "Basic",
                "Free",
                "Standard",
                "Premium"
              ],
              "metadata": {
                "description": "SKU Tier. This field is required to be implemented by the Resource Provider if the service has more than one tier, but is not required on a PUT."
              }
            }
          },
          "variables": {
            "discoveryURL": "[format('https://{0}.api.azureml.ms/discovery', parameters('solutionLocation'))]"
          },
          "resources": [
            {
              "type": "Microsoft.MachineLearningServices/workspaces",
              "apiVersion": "2025-07-01-preview",
              "name": "[parameters('mlwsName')]",
              "location": "[parameters('solutionLocation')]",
              "sku": {
                "name": "[parameters('skuName')]",
                "tier": "[parameters('skuTier')]"
              },
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', parameters('managedIdentityId'))]": {}
                }
              },
              "properties": {
                "primaryUserAssignedIdentity": "[parameters('managedIdentityId')]",
                "friendlyName": "[parameters('mlwsName')]",
                "storageAccount": "[parameters('storageAccount')]",
                "keyVault": "[parameters('keyVault')]",
                "applicationInsights": "[parameters('applicationInsights')]",
                "hbiWorkspace": false,
                "v1LegacyMode": false,
                "containerRegistry": "[parameters('containerRegistry')]",
                "publicNetworkAccess": "[parameters('publicNetworkAccess')]",
                "discoveryUrl": "[variables('discoveryURL')]"
              }
            }
          ],
          "outputs": {
            "machineLearningWorkspaceOutput": {
              "type": "object",
              "value": {
                "id": "[resourceId('Microsoft.MachineLearningServices/workspaces', parameters('mlwsName'))]",
                "name": "[parameters('mlwsName')]"
              }
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgAnalyticsName')), 'Microsoft.Resources/deployments', format('{0}-applicationInsightsDeployment', parameters('solutionName')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgStorageName')), 'Microsoft.Resources/deployments', format('{0}-containerRegistryDeployment', parameters('solutionName')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgStorageName')), 'Microsoft.Resources/deployments', format('{0}-keyvaultDeployment', parameters('solutionName')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgServicesName')), 'Microsoft.Resources/deployments', format('{0}-managedIdentityDeployment', parameters('solutionName')))]",
        "[subscriptionResourceId(parameters('subscriptionId'), 'Microsoft.Resources/deployments', format('{0}-resourceGroupsDeployment', parameters('solutionName')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgStorageName')), 'Microsoft.Resources/deployments', format('{0}-storageAccountDeploymentForMLWS', parameters('solutionName')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('{0}-dbwskvCryptoServiceEncryptionUserRoleAssignment', parameters('solutionName'))]",
      "resourceGroup": "[variables('rgStorageName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "managedIdentityId": {
            "value": "databricksWorkspaceManagedIdentityClientId"
          },
          "managedIdentityPrincipalId": {
            "value": "[variables('azureDatabricksEnterpriseApplicationObjectId')]"
          },
          "keyvaultName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgStorageName')), 'Microsoft.Resources/deployments', format('{0}-keyvaultDeployment', parameters('solutionName'))), '2025-04-01').outputs.keyvaultOutput.value.name]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "11196384688024286091"
            }
          },
          "parameters": {
            "keyvaultName": {
              "type": "string",
              "metadata": {
                "description": "Keyvault Name. The name of the Keyvault where the encryption key is stored."
              }
            },
            "managedIdentityId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Managed Identity Id. The client ID of the user assigned identity to be used for kubelet identity."
              }
            },
            "managedIdentityPrincipalId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Managed Identity Principal Id. The object ID of the user assigned identity to be used for kubelet identity."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.KeyVault/vaults/{0}', parameters('keyvaultName'))]",
              "name": "[guid(parameters('managedIdentityId'), resourceId('Microsoft.KeyVault/vaults', parameters('keyvaultName')), 'Key Vault Crypto Service Encryption User')]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'e147488a-f6f5-4113-8e2d-b22465e65bf6')]",
                "principalId": "[parameters('managedIdentityPrincipalId')]",
                "principalType": "ServicePrincipal"
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgStorageName')), 'Microsoft.Resources/deployments', format('{0}-keyvaultDeployment', parameters('solutionName')))]",
        "[subscriptionResourceId(parameters('subscriptionId'), 'Microsoft.Resources/deployments', format('{0}-resourceGroupsDeployment', parameters('solutionName')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('{0}-databricksWorkspaceDeployment', parameters('solutionName'))]",
      "resourceGroup": "[variables('rgDataName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "solutionName": {
            "value": "[parameters('solutionName')]"
          },
          "solutionLocation": {
            "value": "[parameters('solutionLocation')]"
          },
          "dbwsName": {
            "value": "[format('{0}-dbws', parameters('solutionName'))]"
          },
          "managedIdentityId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgServicesName')), 'Microsoft.Resources/deployments', format('{0}-managedIdentityDeployment', parameters('solutionName'))), '2025-04-01').outputs.managedIdentityOutput.value.id]"
          },
          "managedIdentityPrincipalId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgServicesName')), 'Microsoft.Resources/deployments', format('{0}-managedIdentityDeployment', parameters('solutionName'))), '2025-04-01').outputs.managedIdentityOutput.value.objectId]"
          },
          "amlWorkspaceId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgAIName')), 'Microsoft.Resources/deployments', format('{0}-machineLearningWorkspaceDeployment', parameters('solutionName'))), '2025-04-01').outputs.machineLearningWorkspaceOutput.value.id]"
          },
          "customVirtualNetworkId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNetworkName')), 'Microsoft.Resources/deployments', format('{0}-virtualNetworkDeployment', parameters('solutionName'))), '2025-04-01').outputs.virtualNetworkOutput.value.id]"
          },
          "customPrivateSubnetName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNetworkName')), 'Microsoft.Resources/deployments', format('{0}-virtualNetworkDeployment', parameters('solutionName'))), '2025-04-01').outputs.virtualNetworkOutput.value.databricksSubnetPrivate.name]"
          },
          "customPublicSubnetName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNetworkName')), 'Microsoft.Resources/deployments', format('{0}-virtualNetworkDeployment', parameters('solutionName'))), '2025-04-01').outputs.virtualNetworkOutput.value.databricksSubnetPublic.name]"
          },
          "storageAccountName": {
            "value": "[format('{0}dbwssa', parameters('solutionName'))]"
          },
          "storageAccountSKU": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgStorageName')), 'Microsoft.Resources/deployments', format('{0}-storageAccountDeployment', parameters('solutionName'))), '2025-04-01').outputs.storageAccountOutput.value.sku]"
          },
          "keyVaultUri": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgStorageName')), 'Microsoft.Resources/deployments', format('{0}-keyvaultDeployment', parameters('solutionName'))), '2025-04-01').outputs.keyvaultOutput.value.uri]"
          },
          "encryptionKeyName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgStorageName')), 'Microsoft.Resources/deployments', format('{0}-keyvaultDeployment', parameters('solutionName'))), '2025-04-01').outputs.keyvaultOutput.value.keys[0].name]"
          },
          "encryptionKeyVersion": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgStorageName')), 'Microsoft.Resources/deployments', format('{0}-keyvaultDeployment', parameters('solutionName'))), '2025-04-01').outputs.keyvaultOutput.value.keys[0].version]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.0",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "11829855766524616421"
            }
          },
          "parameters": {
            "solutionName": {
              "type": "string",
              "minLength": 3,
              "maxLength": 15,
              "metadata": {
                "description": "Solution Name"
              }
            },
            "solutionLocation": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Solution Location"
              }
            },
            "managedIdentityId": {
              "type": "string",
              "metadata": {
                "description": "Managed Identity ID. The Azure resource Id of the managed identity used for the deployment."
              }
            },
            "managedIdentityPrincipalId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Managed Identity Principal Id. The principal id of the user assigned identity used for the deployment."
              }
            },
            "skuTier": {
              "type": "string",
              "defaultValue": "Premium",
              "allowedValues": [
                "Trial",
                "Standard",
                "Premium"
              ],
              "metadata": {
                "description": "The pricing tier of workspace."
              }
            },
            "defaultStorageFirewall": {
              "type": "string",
              "defaultValue": "Enabled",
              "allowedValues": [
                "Disabled",
                "Enabled"
              ],
              "metadata": {
                "description": "Default Storage Firewall. Whether to enable the firewall for the default storage account associated with the workspace."
              }
            },
            "amlWorkspaceId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "AML Workspace Id. The Azure resource Id of the Machine Learning workspace to be associated with this Databricks workspace."
              }
            },
            "customVirtualNetworkId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Custom Virtual Network Id. The Azure resource Id of the custom virtual network to be used by the workspace."
              }
            },
            "customPrivateSubnetName": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Custom Private Subnet Name. The name of the custom private subnet in the virtual network to be used by the workspace."
              }
            },
            "customPublicSubnetName": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Custom Public Subnet Name. The name of the custom public subnet in the virtual network to be used by the workspace."
              }
            },
            "enableNoPublicIp": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable No Public Ip. Whether to disable public IP for the workspace."
              }
            },
            "publicNetworkAccess": {
              "type": "string",
              "defaultValue": "Enabled",
              "allowedValues": [
                "Disabled",
                "Enabled"
              ],
              "metadata": {
                "description": "Public Network Access. Whether or not public endpoint access is allowed for this workspace."
              }
            },
            "storageAccountName": {
              "type": "string",
              "defaultValue": "[format('{0}dbwssa', parameters('solutionName'))]",
              "metadata": {
                "description": "Storage Account Name. The name of the storage account to be associated with this workspace."
              }
            },
            "storageAccountSKU": {
              "type": "string",
              "defaultValue": "Standard_LRS",
              "metadata": {
                "description": "Storage Account SKU. The SKU of the storage account to be associated with this workspace."
              }
            },
            "keyVaultUri": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Encryption Key Vault Uri. The URI of the key vault to be used for encryption at rest with customer-managed keys."
              }
            },
            "encryptionKeyName": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Encryption Key Name. The name of the key in Key Vault to be used for encryption at rest with customer-managed keys."
              }
            },
            "encryptionKeyVersion": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Encryption Key Version. The version of the key in Key Vault to be used for encryption at rest with customer-managed keys. If not provided, the latest version of the key will be used."
              }
            },
            "dbwsName": {
              "type": "string",
              "defaultValue": "[format('{0}-dbws', parameters('solutionName'))]",
              "metadata": {
                "description": "Name"
              }
            }
          },
          "variables": {
            "dbwsacName": "[format('{0}-dbwsac', parameters('solutionName'))]",
            "managedResourceGroupId": "[format('/subscriptions/{0}/resourceGroups/{1}_{2}_databricks', subscription().subscriptionId, parameters('solutionName'), parameters('solutionLocation'))]"
          },
          "resources": {
            "accessConector": {
              "type": "Microsoft.Databricks/accessConnectors",
              "apiVersion": "2025-03-01-preview",
              "name": "[variables('dbwsacName')]",
              "location": "[parameters('solutionLocation')]",
              "tags": {
                "app": "[parameters('solutionName')]",
                "location": "[parameters('solutionLocation')]"
              },
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', parameters('managedIdentityId'))]": {}
                }
              },
              "properties": {}
            },
            "databricksWorkspace": {
              "type": "Microsoft.Databricks/workspaces",
              "apiVersion": "2025-03-01-preview",
              "name": "[parameters('dbwsName')]",
              "location": "[parameters('solutionLocation')]",
              "tags": {
                "app": "[parameters('solutionName')]",
                "location": "[parameters('solutionLocation')]"
              },
              "sku": {
                "name": "[parameters('skuTier')]"
              },
              "properties": {
                "authorizations": [
                  {
                    "principalId": "[parameters('managedIdentityPrincipalId')]",
                    "roleDefinitionId": "8e3af657-a8ff-443c-a75c-2fe8c4bcb635"
                  }
                ],
                "managedResourceGroupId": "[variables('managedResourceGroupId')]",
                "publicNetworkAccess": "[parameters('publicNetworkAccess')]",
                "requiredNsgRules": "AllRules",
                "defaultStorageFirewall": "[parameters('defaultStorageFirewall')]",
                "defaultCatalog": {
                  "initialType": "UnityCatalog"
                },
                "accessConnector": {
                  "id": "[resourceId('Microsoft.Databricks/accessConnectors', variables('dbwsacName'))]",
                  "identityType": "UserAssigned",
                  "userAssignedIdentityId": "[parameters('managedIdentityId')]"
                },
                "encryption": {
                  "entities": {
                    "managedDisk": {
                      "keySource": "Microsoft.Keyvault",
                      "keyVaultProperties": {
                        "keyVaultUri": "[parameters('keyVaultUri')]",
                        "keyName": "[parameters('encryptionKeyName')]",
                        "keyVersion": "[parameters('encryptionKeyVersion')]"
                      },
                      "rotationToLatestKeyVersionEnabled": true
                    },
                    "managedServices": {
                      "keySource": "Microsoft.Keyvault",
                      "keyVaultProperties": {
                        "keyVaultUri": "[parameters('keyVaultUri')]",
                        "keyName": "[parameters('encryptionKeyName')]",
                        "keyVersion": "[parameters('encryptionKeyVersion')]"
                      }
                    }
                  }
                },
                "enhancedSecurityCompliance": {
                  "automaticClusterUpdate": {
                    "value": "Enabled"
                  },
                  "enhancedSecurityMonitoring": {
                    "value": "Enabled"
                  },
                  "complianceSecurityProfile": {
                    "complianceStandards": [
                      "HITRUST",
                      "PCI_DSS",
                      "HIPAA"
                    ],
                    "value": "Enabled"
                  }
                },
                "parameters": {
                  "amlWorkspaceId": {
                    "value": "[parameters('amlWorkspaceId')]"
                  },
                  "customVirtualNetworkId": {
                    "value": "[parameters('customVirtualNetworkId')]"
                  },
                  "customPrivateSubnetName": {
                    "value": "[parameters('customPrivateSubnetName')]"
                  },
                  "customPublicSubnetName": {
                    "value": "[parameters('customPublicSubnetName')]"
                  },
                  "enableNoPublicIp": {
                    "value": "[parameters('enableNoPublicIp')]"
                  },
                  "prepareEncryption": {
                    "value": true
                  },
                  "requireInfrastructureEncryption": {
                    "value": true
                  },
                  "storageAccountName": {
                    "value": "[parameters('storageAccountName')]"
                  },
                  "storageAccountSkuName": {
                    "value": "[parameters('storageAccountSKU')]"
                  }
                }
              },
              "dependsOn": [
                "accessConector"
              ]
            }
          },
          "outputs": {
            "databricksWorkspaceOutput": {
              "type": "object",
              "value": {
                "id": "[resourceId('Microsoft.Databricks/workspaces', parameters('dbwsName'))]",
                "name": "[parameters('dbwsName')]",
                "sku": "[reference('databricksWorkspace', '2025-03-01-preview', 'full').sku]",
                "properties": "[reference('databricksWorkspace')]"
              }
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgStorageName')), 'Microsoft.Resources/deployments', format('{0}-keyvaultDeployment', parameters('solutionName')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgAIName')), 'Microsoft.Resources/deployments', format('{0}-machineLearningWorkspaceDeployment', parameters('solutionName')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgServicesName')), 'Microsoft.Resources/deployments', format('{0}-managedIdentityDeployment', parameters('solutionName')))]",
        "[subscriptionResourceId(parameters('subscriptionId'), 'Microsoft.Resources/deployments', format('{0}-resourceGroupsDeployment', parameters('solutionName')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgStorageName')), 'Microsoft.Resources/deployments', format('{0}-storageAccountDeployment', parameters('solutionName')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNetworkName')), 'Microsoft.Resources/deployments', format('{0}-virtualNetworkGatewayDeployment', parameters('solutionName')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNetworkName')), 'Microsoft.Resources/deployments', format('{0}-virtualNetworkDeployment', parameters('solutionName')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('{0}-synapseAnalyticsWorkspaceDeployment', parameters('solutionName'))]",
      "resourceGroup": "[variables('rgAnalyticsName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "solutionName": {
            "value": "[parameters('solutionName')]"
          },
          "solutionLocation": {
            "value": "[parameters('solutionLocation')]"
          },
          "dlsResourceId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgStorageName')), 'Microsoft.Resources/deployments', format('{0}-storageAccountDeploymentForMLWS', parameters('solutionName'))), '2025-04-01').outputs.storageAccountOutput.value.id]"
          },
          "dlsAccountUrl": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgStorageName')), 'Microsoft.Resources/deployments', format('{0}-storageAccountDeploymentForMLWS', parameters('solutionName'))), '2025-04-01').outputs.storageAccountOutput.value.dfs]"
          },
          "dlsFileSystem": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgStorageName')), 'Microsoft.Resources/deployments', format('{0}-storageAccountDeploymentForMLWS', parameters('solutionName'))), '2025-04-01').outputs.storageAccountOutput.value.dataContainer]"
          },
          "managedIdentityId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgServicesName')), 'Microsoft.Resources/deployments', format('{0}-managedIdentityDeployment', parameters('solutionName'))), '2025-04-01').outputs.managedIdentityOutput.value.id]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "15144786389117666633"
            }
          },
          "parameters": {
            "solutionName": {
              "type": "string",
              "metadata": {
                "description": "Solution Name"
              }
            },
            "solutionLocation": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Solution Location"
              }
            },
            "dlsAccountUrl": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Data Lake Storage Account URL."
              }
            },
            "dlsFileSystem": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Data Lake Storage File System."
              }
            },
            "dlsResourceId": {
              "type": "string",
              "metadata": {
                "description": "Data Lake Storage Resource Id. ARM resource Id of this storage account"
              }
            },
            "managedIdentityId": {
              "type": "string",
              "metadata": {
                "description": "Managed Identity ID. The Azure resource Id of the managed identity used for the deployment."
              }
            }
          },
          "variables": {
            "sawsName": "[format('{0}-saws', parameters('solutionName'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Synapse/workspaces",
              "apiVersion": "2021-06-01",
              "name": "[variables('sawsName')]",
              "location": "[parameters('solutionLocation')]",
              "identity": {
                "type": "SystemAssigned,UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', parameters('managedIdentityId'))]": {}
                }
              },
              "properties": {
                "defaultDataLakeStorage": {
                  "resourceId": "[parameters('dlsResourceId')]",
                  "createManagedPrivateEndpoint": false,
                  "accountUrl": "[parameters('dlsAccountUrl')]",
                  "filesystem": "[parameters('dlsFileSystem')]"
                },
                "encryption": {},
                "sqlAdministratorLogin": "sqladminuser",
                "privateEndpointConnections": [],
                "publicNetworkAccess": "Enabled",
                "azureADOnlyAuthentication": false,
                "trustedServiceBypassEnabled": true
              }
            },
            {
              "type": "Microsoft.Synapse/workspaces/azureADOnlyAuthentications",
              "apiVersion": "2021-06-01",
              "name": "[format('{0}/{1}', variables('sawsName'), 'default')]",
              "properties": {
                "azureADOnlyAuthentication": false
              },
              "dependsOn": [
                "[resourceId('Microsoft.Synapse/workspaces', variables('sawsName'))]"
              ]
            },
            {
              "type": "Microsoft.Synapse/workspaces/bigDataPools",
              "apiVersion": "2021-06-01",
              "name": "[format('{0}/{1}', variables('sawsName'), 'sparkpoolforml')]",
              "location": "[parameters('solutionLocation')]",
              "properties": {
                "sparkVersion": "3.5",
                "nodeCount": 10,
                "nodeSize": "Medium",
                "nodeSizeFamily": "MemoryOptimized",
                "autoScale": {
                  "enabled": true,
                  "minNodeCount": 3,
                  "maxNodeCount": 10
                },
                "autoPause": {
                  "enabled": true,
                  "delayInMinutes": 15
                },
                "isComputeIsolationEnabled": false,
                "sessionLevelPackagesEnabled": false,
                "dynamicExecutorAllocation": {
                  "enabled": false
                },
                "isAutotuneEnabled": false,
                "provisioningState": "Succeeded"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Synapse/workspaces', variables('sawsName'))]"
              ]
            },
            {
              "type": "Microsoft.Synapse/workspaces/dedicatedSQLminimalTlsSettings",
              "apiVersion": "2021-06-01",
              "name": "[format('{0}/{1}', variables('sawsName'), 'default')]",
              "properties": {
                "minimalTlsVersion": "1.2"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Synapse/workspaces', variables('sawsName'))]"
              ]
            },
            {
              "type": "Microsoft.Synapse/workspaces/firewallRules",
              "apiVersion": "2021-06-01",
              "name": "[format('{0}/{1}', variables('sawsName'), 'allowAll')]",
              "properties": {
                "startIpAddress": "0.0.0.0",
                "endIpAddress": "255.255.255.255"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Synapse/workspaces', variables('sawsName'))]"
              ]
            },
            {
              "type": "Microsoft.Synapse/workspaces/firewallRules",
              "apiVersion": "2021-06-01",
              "name": "[format('{0}/{1}', variables('sawsName'), 'AllowAllWindowsAzureIps')]",
              "properties": {
                "startIpAddress": "0.0.0.0",
                "endIpAddress": "0.0.0.0"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Synapse/workspaces', variables('sawsName'))]"
              ]
            },
            {
              "type": "Microsoft.Synapse/workspaces/integrationRuntimes",
              "apiVersion": "2021-06-01",
              "name": "[format('{0}/{1}', variables('sawsName'), 'AutoResolveIntegrationRuntime')]",
              "properties": {
                "type": "Managed",
                "typeProperties": {
                  "computeProperties": {
                    "location": "AutoResolve"
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Synapse/workspaces', variables('sawsName'))]"
              ]
            }
          ],
          "outputs": {
            "SypnaseAnalyticsWorkspaceOutput": {
              "type": "object",
              "value": {
                "name": "[variables('sawsName')]",
                "synapseIdentity": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.ManagedIdentity/systemAssignedIdentities/{2}', subscription().id, resourceGroup().name, variables('sawsName'))]"
              }
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgServicesName')), 'Microsoft.Resources/deployments', format('{0}-managedIdentityDeployment', parameters('solutionName')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgStorageName')), 'Microsoft.Resources/deployments', format('{0}-storageAccountDeploymentForMLWS', parameters('solutionName')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('{0}-privateEndpointFromAKSToASADeployment', parameters('solutionName'))]",
      "resourceGroup": "[variables('rgNetworkName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "solutionLocation": {
            "value": "[parameters('solutionLocation')]"
          },
          "serviceName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgServicesName')), 'Microsoft.Resources/deployments', format('{0}-kubernetesServicesDeployment', parameters('solutionName'))), '2025-04-01').outputs.kubernetesServicesOutput.value.name]"
          },
          "subnetId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNetworkName')), 'Microsoft.Resources/deployments', format('{0}-virtualNetworkDeployment', parameters('solutionName'))), '2025-04-01').outputs.virtualNetworkOutput.value.servicesSubnet.id]"
          },
          "resourceNameForPE": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgStorageName')), 'Microsoft.Resources/deployments', format('{0}-storageAccountDeployment', parameters('solutionName'))), '2025-04-01').outputs.storageAccountOutput.value.name]"
          },
          "resourceIdForPE": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgStorageName')), 'Microsoft.Resources/deployments', format('{0}-storageAccountDeployment', parameters('solutionName'))), '2025-04-01').outputs.storageAccountOutput.value.id]"
          },
          "resourceGroupIdsForPE": {
            "value": [
              "blob"
            ]
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "668365124553952998"
            }
          },
          "parameters": {
            "solutionLocation": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "The location of the Managed Cluster resource."
              }
            },
            "serviceName": {
              "type": "string",
              "metadata": {
                "description": "Service Name. The name of the service resource"
              }
            },
            "subnetId": {
              "type": "string",
              "metadata": {
                "description": "Subnet ID. Id of the subnet for the private endpoint."
              }
            },
            "resourceNameForPE": {
              "type": "string",
              "metadata": {
                "description": "Resource Name for Private EndPoint. Resource name for the private endpoint."
              }
            },
            "resourceIdForPE": {
              "type": "string",
              "metadata": {
                "description": "Resource Id for Private EndPoint. Resource Id for the private endpoint"
              }
            },
            "resourceGroupIdsForPE": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Resource Group Ids for Private EndPoint. Resource group ids of the Resource for the private endpoint"
              }
            }
          },
          "variables": {
            "peResourceName": "[format('{0}To{1}-pe', parameters('serviceName'), parameters('resourceNameForPE'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2024-10-01",
              "name": "[variables('peResourceName')]",
              "location": "[parameters('solutionLocation')]",
              "properties": {
                "subnet": {
                  "id": "[parameters('subnetId')]"
                },
                "privateLinkServiceConnections": [
                  {
                    "name": "[format('{0}-plsc', variables('peResourceName'))]",
                    "properties": {
                      "privateLinkServiceId": "[parameters('resourceIdForPE')]",
                      "groupIds": "[parameters('resourceGroupIdsForPE')]"
                    }
                  }
                ]
              }
            }
          ],
          "outputs": {
            "resourcePrivateEndPointOutput": {
              "type": "object",
              "value": {
                "id": "[resourceId('Microsoft.Network/privateEndpoints', variables('peResourceName'))]",
                "name": "[variables('peResourceName')]"
              }
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgServicesName')), 'Microsoft.Resources/deployments', format('{0}-kubernetesServicesDeployment', parameters('solutionName')))]",
        "[subscriptionResourceId(parameters('subscriptionId'), 'Microsoft.Resources/deployments', format('{0}-resourceGroupsDeployment', parameters('solutionName')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgStorageName')), 'Microsoft.Resources/deployments', format('{0}-storageAccountDeployment', parameters('solutionName')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNetworkName')), 'Microsoft.Resources/deployments', format('{0}-virtualNetworkDeployment', parameters('solutionName')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('{0}-privateDnsZoneFromAKSToASADeployment', parameters('solutionName'))]",
      "resourceGroup": "[variables('rgNetworkName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "solutionName": {
            "value": "[parameters('solutionName')]"
          },
          "privateEndPointName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNetworkName')), 'Microsoft.Resources/deployments', format('{0}-privateEndpointFromAKSToASADeployment', parameters('solutionName'))), '2025-04-01').outputs.resourcePrivateEndPointOutput.value.name]"
          },
          "privateDNSZoneName": {
            "value": "[format('{0}.privatelink.blob.{1}', parameters('solutionName'), environment().suffixes.storage)]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "16673996982169839248"
            }
          },
          "parameters": {
            "solutionName": {
              "type": "string",
              "metadata": {
                "description": "Solution Name. Solution Name Prefix to be used for all resources."
              }
            },
            "privateEndPointName": {
              "type": "string",
              "metadata": {
                "description": "Private End-Point Name. The name of the private endpoint to be used."
              }
            },
            "privateDNSZoneName": {
              "type": "string",
              "metadata": {
                "description": "Private DNS Zone Name. The name of the private DNS zone to be used for the private endpoint."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Network/privateDnsZones",
              "apiVersion": "2024-06-01",
              "name": "[parameters('privateDNSZoneName')]",
              "location": "global"
            },
            {
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2024-10-01",
              "name": "[format('{0}/{1}', parameters('privateEndPointName'), 'default')]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "[format('{0}Config', parameters('solutionName'))]",
                    "properties": {
                      "privateDnsZoneId": "[resourceId('Microsoft.Network/privateDnsZones', parameters('privateDNSZoneName'))]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateDnsZones', parameters('privateDNSZoneName'))]"
              ]
            }
          ],
          "outputs": {
            "privateDnsZoneOutput": {
              "type": "object",
              "value": {
                "id": "[resourceId('Microsoft.Network/privateDnsZones', parameters('privateDNSZoneName'))]",
                "name": "[parameters('privateDNSZoneName')]"
              }
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNetworkName')), 'Microsoft.Resources/deployments', format('{0}-privateEndpointFromAKSToASADeployment', parameters('solutionName')))]",
        "[subscriptionResourceId(parameters('subscriptionId'), 'Microsoft.Resources/deployments', format('{0}-resourceGroupsDeployment', parameters('solutionName')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('{0}-privateEndpointFromAKSToACRDeployment', parameters('solutionName'))]",
      "resourceGroup": "[variables('rgNetworkName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "solutionLocation": {
            "value": "[parameters('solutionLocation')]"
          },
          "serviceName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgServicesName')), 'Microsoft.Resources/deployments', format('{0}-kubernetesServicesDeployment', parameters('solutionName'))), '2025-04-01').outputs.kubernetesServicesOutput.value.name]"
          },
          "subnetId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNetworkName')), 'Microsoft.Resources/deployments', format('{0}-virtualNetworkDeployment', parameters('solutionName'))), '2025-04-01').outputs.virtualNetworkOutput.value.servicesSubnet.id]"
          },
          "resourceNameForPE": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgStorageName')), 'Microsoft.Resources/deployments', format('{0}-containerRegistryDeployment', parameters('solutionName'))), '2025-04-01').outputs.containerRegistryOutput.value.name]"
          },
          "resourceIdForPE": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgStorageName')), 'Microsoft.Resources/deployments', format('{0}-containerRegistryDeployment', parameters('solutionName'))), '2025-04-01').outputs.containerRegistryOutput.value.id]"
          },
          "resourceGroupIdsForPE": {
            "value": [
              "registry"
            ]
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "668365124553952998"
            }
          },
          "parameters": {
            "solutionLocation": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "The location of the Managed Cluster resource."
              }
            },
            "serviceName": {
              "type": "string",
              "metadata": {
                "description": "Service Name. The name of the service resource"
              }
            },
            "subnetId": {
              "type": "string",
              "metadata": {
                "description": "Subnet ID. Id of the subnet for the private endpoint."
              }
            },
            "resourceNameForPE": {
              "type": "string",
              "metadata": {
                "description": "Resource Name for Private EndPoint. Resource name for the private endpoint."
              }
            },
            "resourceIdForPE": {
              "type": "string",
              "metadata": {
                "description": "Resource Id for Private EndPoint. Resource Id for the private endpoint"
              }
            },
            "resourceGroupIdsForPE": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Resource Group Ids for Private EndPoint. Resource group ids of the Resource for the private endpoint"
              }
            }
          },
          "variables": {
            "peResourceName": "[format('{0}To{1}-pe', parameters('serviceName'), parameters('resourceNameForPE'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2024-10-01",
              "name": "[variables('peResourceName')]",
              "location": "[parameters('solutionLocation')]",
              "properties": {
                "subnet": {
                  "id": "[parameters('subnetId')]"
                },
                "privateLinkServiceConnections": [
                  {
                    "name": "[format('{0}-plsc', variables('peResourceName'))]",
                    "properties": {
                      "privateLinkServiceId": "[parameters('resourceIdForPE')]",
                      "groupIds": "[parameters('resourceGroupIdsForPE')]"
                    }
                  }
                ]
              }
            }
          ],
          "outputs": {
            "resourcePrivateEndPointOutput": {
              "type": "object",
              "value": {
                "id": "[resourceId('Microsoft.Network/privateEndpoints', variables('peResourceName'))]",
                "name": "[variables('peResourceName')]"
              }
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgStorageName')), 'Microsoft.Resources/deployments', format('{0}-containerRegistryDeployment', parameters('solutionName')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgServicesName')), 'Microsoft.Resources/deployments', format('{0}-kubernetesServicesDeployment', parameters('solutionName')))]",
        "[subscriptionResourceId(parameters('subscriptionId'), 'Microsoft.Resources/deployments', format('{0}-resourceGroupsDeployment', parameters('solutionName')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNetworkName')), 'Microsoft.Resources/deployments', format('{0}-virtualNetworkDeployment', parameters('solutionName')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('{0}-privateDnsZoneFromAKSToACRDeployment', parameters('solutionName'))]",
      "resourceGroup": "[variables('rgNetworkName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "solutionName": {
            "value": "[parameters('solutionName')]"
          },
          "privateEndPointName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNetworkName')), 'Microsoft.Resources/deployments', format('{0}-privateEndpointFromAKSToACRDeployment', parameters('solutionName'))), '2025-04-01').outputs.resourcePrivateEndPointOutput.value.name]"
          },
          "privateDNSZoneName": {
            "value": "[format('{0}.privatelink{1}', parameters('solutionName'), environment().suffixes.acrLoginServer)]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "16673996982169839248"
            }
          },
          "parameters": {
            "solutionName": {
              "type": "string",
              "metadata": {
                "description": "Solution Name. Solution Name Prefix to be used for all resources."
              }
            },
            "privateEndPointName": {
              "type": "string",
              "metadata": {
                "description": "Private End-Point Name. The name of the private endpoint to be used."
              }
            },
            "privateDNSZoneName": {
              "type": "string",
              "metadata": {
                "description": "Private DNS Zone Name. The name of the private DNS zone to be used for the private endpoint."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Network/privateDnsZones",
              "apiVersion": "2024-06-01",
              "name": "[parameters('privateDNSZoneName')]",
              "location": "global"
            },
            {
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2024-10-01",
              "name": "[format('{0}/{1}', parameters('privateEndPointName'), 'default')]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "[format('{0}Config', parameters('solutionName'))]",
                    "properties": {
                      "privateDnsZoneId": "[resourceId('Microsoft.Network/privateDnsZones', parameters('privateDNSZoneName'))]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateDnsZones', parameters('privateDNSZoneName'))]"
              ]
            }
          ],
          "outputs": {
            "privateDnsZoneOutput": {
              "type": "object",
              "value": {
                "id": "[resourceId('Microsoft.Network/privateDnsZones', parameters('privateDNSZoneName'))]",
                "name": "[parameters('privateDNSZoneName')]"
              }
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNetworkName')), 'Microsoft.Resources/deployments', format('{0}-privateEndpointFromAKSToACRDeployment', parameters('solutionName')))]",
        "[subscriptionResourceId(parameters('subscriptionId'), 'Microsoft.Resources/deployments', format('{0}-resourceGroupsDeployment', parameters('solutionName')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('{0}-privateEndpointFromAKSToSQLDeployment', parameters('solutionName'))]",
      "resourceGroup": "[variables('rgNetworkName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "solutionLocation": {
            "value": "[parameters('solutionLocation')]"
          },
          "serviceName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgServicesName')), 'Microsoft.Resources/deployments', format('{0}-kubernetesServicesDeployment', parameters('solutionName'))), '2025-04-01').outputs.kubernetesServicesOutput.value.name]"
          },
          "subnetId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNetworkName')), 'Microsoft.Resources/deployments', format('{0}-virtualNetworkDeployment', parameters('solutionName'))), '2025-04-01').outputs.virtualNetworkOutput.value.servicesSubnet.id]"
          },
          "resourceNameForPE": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgDataName')), 'Microsoft.Resources/deployments', format('{0}-sqlServerDeployment', parameters('solutionName'))), '2025-04-01').outputs.sqlServerOutput.value.name]"
          },
          "resourceIdForPE": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgDataName')), 'Microsoft.Resources/deployments', format('{0}-sqlServerDeployment', parameters('solutionName'))), '2025-04-01').outputs.sqlServerOutput.value.id]"
          },
          "resourceGroupIdsForPE": {
            "value": [
              "sqlServer"
            ]
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "668365124553952998"
            }
          },
          "parameters": {
            "solutionLocation": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "The location of the Managed Cluster resource."
              }
            },
            "serviceName": {
              "type": "string",
              "metadata": {
                "description": "Service Name. The name of the service resource"
              }
            },
            "subnetId": {
              "type": "string",
              "metadata": {
                "description": "Subnet ID. Id of the subnet for the private endpoint."
              }
            },
            "resourceNameForPE": {
              "type": "string",
              "metadata": {
                "description": "Resource Name for Private EndPoint. Resource name for the private endpoint."
              }
            },
            "resourceIdForPE": {
              "type": "string",
              "metadata": {
                "description": "Resource Id for Private EndPoint. Resource Id for the private endpoint"
              }
            },
            "resourceGroupIdsForPE": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Resource Group Ids for Private EndPoint. Resource group ids of the Resource for the private endpoint"
              }
            }
          },
          "variables": {
            "peResourceName": "[format('{0}To{1}-pe', parameters('serviceName'), parameters('resourceNameForPE'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2024-10-01",
              "name": "[variables('peResourceName')]",
              "location": "[parameters('solutionLocation')]",
              "properties": {
                "subnet": {
                  "id": "[parameters('subnetId')]"
                },
                "privateLinkServiceConnections": [
                  {
                    "name": "[format('{0}-plsc', variables('peResourceName'))]",
                    "properties": {
                      "privateLinkServiceId": "[parameters('resourceIdForPE')]",
                      "groupIds": "[parameters('resourceGroupIdsForPE')]"
                    }
                  }
                ]
              }
            }
          ],
          "outputs": {
            "resourcePrivateEndPointOutput": {
              "type": "object",
              "value": {
                "id": "[resourceId('Microsoft.Network/privateEndpoints', variables('peResourceName'))]",
                "name": "[variables('peResourceName')]"
              }
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgServicesName')), 'Microsoft.Resources/deployments', format('{0}-kubernetesServicesDeployment', parameters('solutionName')))]",
        "[subscriptionResourceId(parameters('subscriptionId'), 'Microsoft.Resources/deployments', format('{0}-resourceGroupsDeployment', parameters('solutionName')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgDataName')), 'Microsoft.Resources/deployments', format('{0}-sqlServerDeployment', parameters('solutionName')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNetworkName')), 'Microsoft.Resources/deployments', format('{0}-virtualNetworkDeployment', parameters('solutionName')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('{0}-privateDnsZoneFromAKSToSQLDeployment', parameters('solutionName'))]",
      "resourceGroup": "[variables('rgNetworkName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "solutionName": {
            "value": "[parameters('solutionName')]"
          },
          "privateEndPointName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNetworkName')), 'Microsoft.Resources/deployments', format('{0}-privateEndpointFromAKSToSQLDeployment', parameters('solutionName'))), '2025-04-01').outputs.resourcePrivateEndPointOutput.value.name]"
          },
          "privateDNSZoneName": {
            "value": "[format('{0}.privatelink{1}', parameters('solutionName'), environment().suffixes.sqlServerHostname)]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "16673996982169839248"
            }
          },
          "parameters": {
            "solutionName": {
              "type": "string",
              "metadata": {
                "description": "Solution Name. Solution Name Prefix to be used for all resources."
              }
            },
            "privateEndPointName": {
              "type": "string",
              "metadata": {
                "description": "Private End-Point Name. The name of the private endpoint to be used."
              }
            },
            "privateDNSZoneName": {
              "type": "string",
              "metadata": {
                "description": "Private DNS Zone Name. The name of the private DNS zone to be used for the private endpoint."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Network/privateDnsZones",
              "apiVersion": "2024-06-01",
              "name": "[parameters('privateDNSZoneName')]",
              "location": "global"
            },
            {
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2024-10-01",
              "name": "[format('{0}/{1}', parameters('privateEndPointName'), 'default')]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "[format('{0}Config', parameters('solutionName'))]",
                    "properties": {
                      "privateDnsZoneId": "[resourceId('Microsoft.Network/privateDnsZones', parameters('privateDNSZoneName'))]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateDnsZones', parameters('privateDNSZoneName'))]"
              ]
            }
          ],
          "outputs": {
            "privateDnsZoneOutput": {
              "type": "object",
              "value": {
                "id": "[resourceId('Microsoft.Network/privateDnsZones', parameters('privateDNSZoneName'))]",
                "name": "[parameters('privateDNSZoneName')]"
              }
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNetworkName')), 'Microsoft.Resources/deployments', format('{0}-privateEndpointFromAKSToSQLDeployment', parameters('solutionName')))]",
        "[subscriptionResourceId(parameters('subscriptionId'), 'Microsoft.Resources/deployments', format('{0}-resourceGroupsDeployment', parameters('solutionName')))]"
      ]
    }
  ]
}